<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Training Assistant - Enhanced 3 Anchor High-Low ME/DE/SE/RE System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: color 0.2s ease, background-color 0.2s ease;
        }

        :root {
            /* Brand Colors from Ignition APG */
            --primary-color: #ff6b35;
            --secondary-color: #f7931e;
            --accent-color: #4ecdc4;
            
            /* Semantic Colors */
            --success-color: #4ecdc4;
            --warning-color: #f7931e;
            --error-color: #e74c3c;
            
            /* Background Colors - Cleaner whites/grays */
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            
            /* Text Colors - Better contrast */
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            
            /* Border Colors */
            --border-color: #e5e5e5;
            --border-light: #f0f0f0;
            
            /* Intensity Indicators */
            --high-intensity: #ff6b35;
            --medium-intensity: #f7931e;
            --low-intensity: #4ecdc4;
            
            /* Shadows - Subtle depth */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --border-color: #404040;
            --border-light: #2a2a2a;
            
            /* Shadows for dark mode */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.6);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-group {
            margin-bottom: 25px;
        }

        .field-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .field-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .dropdown {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown:hover {
            border-color: #d0d0d0;
        }

        .dropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
            background: var(--bg-primary);
        }

        .toggle-technical {
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }

        .toggle-technical:hover {
            color: #e55a2b;
        }

        .technical-details {
            display: none;
            margin-top: 8px;
        }

        .technical-details.show {
            display: block;
        }

        .technical-note {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-left: 3px solid var(--primary-color);
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            border-radius: 0 6px 6px 0;
            line-height: 1.4;
        }

        .technical-note strong {
            color: var(--text-primary);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.01em;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.25);
        }

        .btn:hover {
            background: #e55a2b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.35);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(255, 107, 53, 0.25);
        }

        .btn-secondary {
            background: var(--text-secondary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .intensity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .high-intensity {
            background: var(--high-intensity);
        }

        .medium-intensity {
            background: var(--medium-intensity);
        }

        .low-intensity {
            background: var(--low-intensity);
        }

        .weekly-plan {
            grid-column: 1 / -1;
        }

        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            border: 1.5px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .high-day {
            border-left: 4px solid var(--high-intensity);
            background: linear-gradient(to right, rgba(255, 107, 53, 0.03) 0%, var(--bg-primary) 100%);
        }

        .medium-day {
            border-left: 4px solid var(--medium-intensity);
            background: linear-gradient(to right, rgba(247, 147, 30, 0.03) 0%, var(--bg-primary) 100%);
        }

        .low-day {
            border-left: 4px solid var(--low-intensity);
            background: linear-gradient(to right, rgba(78, 205, 196, 0.03) 0%, var(--bg-primary) 100%);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .day-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .exercise-section {
            margin-bottom: 20px;
        }

        .section-header {
            margin: 0 0 16px 0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .field-section .section-header {
            color: var(--accent-color);
        }

        .lifting-section .section-header {
            color: var(--primary-color);
        }

        .exercise-list {
            list-style: none;
        }

        .exercise-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            transition: all 0.15s ease;
            border: 1px solid var(--border-light);
        }

        .exercise-item.expandable {
            cursor: pointer;
        }

        .exercise-item.expandable:hover {
            background: var(--bg-tertiary);
            box-shadow: var(--shadow-sm);
        }

        .exercise-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
        }

        .exercise-name {
            flex: 1;
            font-weight: 500;
        }

        .exercise-quick-info {
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 10px;
        }

        .expand-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .exercise-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .exercise-details {
            padding: 0 15px 15px 15px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .exercise-item.expanded .exercise-details {
            display: block;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .param {
            font-size: 14px;
        }

        .param strong {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .param .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .param.full-width {
            grid-column: 1 / -1;
        }

        .field-exercise {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid var(--accent-color);
        }

        .lifting-exercise {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid var(--primary-color);
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }

        .modification-panel {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .chat-interface {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
            background: var(--bg-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.03em;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .collapsible {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .collapsible-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .collapsible-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible.active .collapsible-content {
            max-height: 200px;
            padding: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        /* Loading state animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .generating {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .plan-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Three Anchor - Vertical Integration + ExerciseDB</h1>
            <button class="theme-toggle" onclick="toggleTheme()">Dark Mode</button>
        </div>

        <div class="dashboard-grid">
            <!-- Input Panel -->
            <div class="card">
                <h2>Training Configuration</h2>

                <div class="field-group">
                    <label class="field-label" for="trainingAge">Step 1: What's your training experience?</label>
                    <p class="field-description">Determines exercise complexity and CNS loading capacity</p>
                    <select class="dropdown" id="trainingAge">
                        <option value="beginner">Beginner/Novice (Introductory)</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced/Elite</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('age-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="age-tech">
                        <strong>Technical terms:</strong> CNS Capacity, Neural Adaptation Potential, Training Complexity Tolerance
                    </div>
                </div>
                
                <div class="field-group">
                    <label class="field-label" for="trainingGoal">Step 2: What's your main goal right now?</label>
                    <p class="field-description">Determines ME/DE/SE/RE method emphasis and volume distribution</p>
                    <select class="dropdown" id="trainingGoal">
                        <option value="hypertrophy">Build Muscle (Repetition Effort Focus)</option>
                        <option value="strength" selected>Get Stronger (Max Effort Focus)</option>
                        <option value="power">Improve Power & Speed (Dynamic Effort Focus)</option>
                        <option value="balanced">Balanced Development (Mixed Methods)</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('goal-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="goal-tech">
                        <strong>Technical terms:</strong> Max Effort (85-100% 1RM), Dynamic Effort (50-75% max speed), Submaximal Effort (75-85%), Repetition Effort (60-75% to failure)
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="splitType">Step 3: How many days can you train per week?</label>
                    <p class="field-description">High-Low pattern optimizes CNS recovery and adaptation</p>
                    <select class="dropdown" id="splitType">
                        <option value="3-day-high-low" selected>3 Days - High-Low Pattern (H-L-H-L-H-L-L)</option>
                        <option value="4-day-high-low">4 Days - High-Low Pattern (H-L-L-H-L-L-L)</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('split-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="split-tech">
                        <strong>High Days:</strong> SAQ + Heavy lifting (8-10 CNS). <strong>Low Days:</strong> Recovery + accessories (3-5 CNS). Ensures proper recovery between high CNS sessions.
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="duration">Step 4: How long are your typical workouts?</label>
                    <p class="field-description">Affects exercise selection and volume distribution</p>
                    <select class="dropdown" id="duration">
                        <option value="45">45 minutes</option>
                        <option value="60" selected>60 minutes (Recommended)</option>
                        <option value="75">75 minutes</option>
                        <option value="90">90+ minutes</option>
                    </select>
                </div>

                <div class="field-group">
                    <label class="field-label" for="trainingBlock">Step 5: What training phase are you in?</label>
                    <p class="field-description">Block periodization determines intensity and volume emphasis</p>
                    <select class="dropdown" id="trainingBlock">
                        <option value="accumulation" selected>Accumulation - Building Strength Base</option>
                        <option value="transmutation">Transmutation - Converting to Power</option>
                        <option value="realization">Realization - Competition Prep</option>
                        <option value="transition-gpp">Transition/GPP - Recovery Phase</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('phase-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="phase-tech">
                        <strong>Accumulation:</strong> Higher volume ME/SE work. <strong>Transmutation:</strong> DE/Power focus. <strong>Realization:</strong> Peak intensity. <strong>GPP:</strong> Movement quality and base building.
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="blockLength">Step 6: How long should this phase last?</label>
                    <p class="field-description">Adaptation time without staleness</p>
                    <select class="dropdown" id="blockLength">
                        <option value="2">2 weeks (Short Adaptation)</option>
                        <option value="3">3 weeks (Moderate Adaptation)</option>
                        <option value="4" selected>4 weeks (Recommended)</option>
                    </select>
                </div>

                <div class="field-group">
                    <label class="field-label" for="equipment">Step 7: What equipment do you have access to?</label>
                    <p class="field-description">Determines exercise selection and ME/DE/SE/RE implementations</p>
                    <select class="dropdown" id="equipment">
                        <option value="full-gym" selected>Full Gym Access (Barbell + Equipment)</option>
                        <option value="basic">Basic Equipment (Dumbbells, Bands, Bench)</option>
                        <option value="bodyweight">Bodyweight Only (Doorway Isometrics)</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('equipment-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="equipment-tech">
                        <strong>Enhanced Database:</strong> Your system + ExerciseDB exercises automatically filtered by equipment. <strong>Bodyweight Max Effort:</strong> Doorway isometrics with 100% force production against immovable objects.
                    </div>
                </div>

                <button class="btn" onclick="generatePlan()">Generate Enhanced Program</button>
            </div>

            <!-- Plan Overview Panel -->
            <div class="card">
                <h2>Plan Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyVolume">16</div>
                        <div class="stat-label">Weekly Exercises</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="highIntensityDays">3</div>
                        <div class="stat-label">High CNS Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lowIntensityDays">2</div>
                        <div class="stat-label">Low CNS Days</div>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        Vertical Integration Sequencing
                        <span>+</span>
                    </div>
                    <div class="collapsible-content">
                        <p>Speed → Power → Strength → Hypertrophy → Endurance. This sequence optimizes neural readiness while managing fatigue accumulation throughout each training session.</p>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        High-Low Training Principles
                        <span>+</span>
                    </div>
                    <div class="collapsible-content">
                        <p>The High-Low training model alternates between high CNS-demanding days (8-10 CNS) and low recovery days (3-5 CNS). This optimizes adaptation while preventing overtraining and ensuring proper recovery.</p>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        ME/DE/SE/RE Methods
                        <span>+</span>
                    </div>
                    <div class="collapsible-content">
                        <p><strong>Max Effort:</strong> 85-100% loads for strength. <strong>Dynamic Effort:</strong> Explosive movements for power. <strong>Submaximal:</strong> 75-85% for strength-endurance. <strong>Repetition:</strong> Higher volume for hypertrophy.</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label>Weekly Progress</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyProgress" style="width: 25%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Plan Display -->
        <div class="card weekly-plan">
            <h2>Enhanced Weekly Training Plan</h2>
            
            <div class="plan-grid" id="weeklyPlanContainer">
                <!-- Plan will be generated here -->
            </div>

            <!-- Modification Panel -->
            <div class="modification-panel">
                <h3>Intelligent Program Modifications</h3>
                <div class="chat-interface">
                    <div id="chatHistory" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
                    <div class="chat-input">
                        <input type="text" class="form-control" id="chatInput" placeholder="e.g., 'make bodyweight only', 'increase power focus', 'more variety', 'reduce CNS load'">
                        <button class="btn" onclick="processModification()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== SAMPLE PACK INTEGRATION ====================
        
        const SAMPLE_PACK_EXERCISES = [
            {
                "exerciseId": "2ORFMoR",
                "name": "hack calf raise",
                "targetMuscles": ["calves"],
                "bodyParts": ["lower legs"],
                "equipments": ["sled machine"],
                "secondaryMuscles": ["hamstrings", "glutes"],
                "instructions": ["Adjust the sled machine to a comfortable weight.", "Stand on the sled machine with your toes on the platform and your heels hanging off.", "Hold onto the handles for stability.", "Raise your heels as high as possible by pushing through the balls of your feet.", "Pause for a moment at the top, then slowly lower your heels back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "2Qh2J1e",
                "name": "sled 45° leg press (side pov)",
                "targetMuscles": ["glutes"],
                "bodyParts": ["upper legs"],
                "equipments": ["sled machine"],
                "secondaryMuscles": ["quadriceps", "hamstrings", "calves"],
                "instructions": ["Adjust the seat of the sled machine so that your knees are at a 90-degree angle when your feet are on the footplate.", "Sit on the sled machine with your back flat against the backrest and your feet shoulder-width apart on the footplate.", "Grip the handles on the sides of the seat for stability.", "Push against the footplate to extend your legs, straightening them completely.", "Pause for a moment at the top, then slowly bend your knees to lower the footplate back to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "3eGE2JC",
                "name": "dumbbell front raise",
                "targetMuscles": ["delts"],
                "bodyParts": ["shoulders"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["biceps", "trapezius"],
                "instructions": ["Stand with your feet shoulder-width apart, holding a dumbbell in each hand with your palms facing your thighs.", "Keeping your arms straight, exhale and lift the dumbbells in front of you until they are at shoulder level.", "Pause for a moment at the top, then inhale and slowly lower the dumbbells back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "3tAXPQ6",
                "name": "dumbbell over bench revers wrist curl",
                "targetMuscles": ["forearms"],
                "bodyParts": ["lower arms"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["biceps", "brachialis"],
                "instructions": ["Sit on a bench with your feet flat on the ground and hold a dumbbell in each hand, palms facing down.", "Rest your forearms on the bench, allowing your wrists to hang off the edge.", "Slowly curl your wrists upward, bringing the dumbbells towards your body.", "Pause for a moment at the top, then slowly lower the dumbbells back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "3TZduzM",
                "name": "barbell incline bench press",
                "targetMuscles": ["pectorals"],
                "bodyParts": ["chest"],
                "equipments": ["barbell"],
                "secondaryMuscles": ["shoulders", "triceps"],
                "instructions": ["Set up an incline bench at a 45-degree angle.", "Lie down on the bench with your feet flat on the ground.", "Grasp the barbell with an overhand grip, slightly wider than shoulder-width apart.", "Unrack the barbell and lower it slowly towards your chest, keeping your elbows at a 45-degree angle.", "Pause for a moment at the bottom, then push the barbell back up to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "3XFdb1Z",
                "name": "cable squatting curl",
                "targetMuscles": ["biceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["cable"],
                "secondaryMuscles": ["forearms"],
                "instructions": ["Attach a cable handle to the lowest setting on a cable machine.", "Stand facing the machine with your feet shoulder-width apart.", "Hold the cable handle with an underhand grip, palms facing up, and arms fully extended.", "Lower your body into a squat position, keeping your back straight and knees behind your toes.", "As you squat down, curl the cable handle towards your shoulders, keeping your elbows close to your sides.", "Pause for a moment at the top of the curl, squeezing your biceps.", "Slowly lower the cable handle back to the starting position, fully extending your arms.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "4dF3maG",
                "name": "dumbbell one arm hammer preacher curl",
                "targetMuscles": ["biceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["forearms"],
                "instructions": ["Sit on a preacher bench with a dumbbell in one hand and your upper arm resting on the pad.", "Hold the dumbbell with a neutral grip (palms facing your body).", "Keeping your upper arm stationary, exhale and curl the dumbbell up towards your shoulder.", "Pause for a moment at the top, squeezing your biceps.", "Inhale and slowly lower the dumbbell back to the starting position.", "Repeat for the desired number of repetitions, then switch arms."]
            },
            {
                "exerciseId": "4dUn2iv",
                "name": "barbell standing close grip curl",
                "targetMuscles": ["biceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["barbell"],
                "secondaryMuscles": ["forearms"],
                "instructions": ["Stand up straight with your feet shoulder-width apart and hold a barbell with an underhand grip, hands close together.", "Keep your elbows close to your torso and your upper arms stationary throughout the movement.", "Exhale as you curl the weights while contracting your biceps. Continue to raise the bar until your biceps are fully contracted and the bar is at shoulder level.", "Hold the contracted position for a brief pause as you squeeze your biceps.", "Inhale as you slowly begin to bring the barbell back to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "5bpPTHv",
                "name": "kettlebell pistol squat",
                "targetMuscles": ["glutes"],
                "bodyParts": ["upper legs"],
                "equipments": ["kettlebell"],
                "secondaryMuscles": ["quadriceps", "hamstrings", "calves"],
                "instructions": ["Stand with your feet shoulder-width apart, holding a kettlebell in front of your chest with both hands.", "Lift your left foot off the ground and extend it forward, keeping it parallel to the ground.", "Slowly lower your body down into a squat position, keeping your right foot flat on the ground and your left leg extended.", "Pause for a moment at the bottom of the squat, then push through your right heel to return to the starting position.", "Repeat for the desired number of repetitions, then switch legs."]
            },
            {
                "exerciseId": "05Cf2v8",
                "name": "impossible dips",
                "targetMuscles": ["triceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["body weight"],
                "secondaryMuscles": ["chest", "shoulders"],
                "instructions": ["Position yourself between two parallel bars with your arms fully extended and your body suspended in the air.", "Bend your knees and cross your ankles.", "Lower your body by bending your elbows until your upper arms are parallel to the ground.", "Pause for a moment, then push yourself back up to the starting position by straightening your arms.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "5uFK1xr",
                "name": "barbell seated overhead triceps extension",
                "targetMuscles": ["triceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["barbell"],
                "secondaryMuscles": ["shoulders"],
                "instructions": ["Sit on a bench with your back straight and feet flat on the ground.", "Hold a barbell with an overhand grip, hands shoulder-width apart, and raise it overhead.", "Lower the barbell behind your head by bending your elbows, keeping your upper arms close to your head.", "Pause for a moment, then extend your arms to raise the barbell back to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "5v7KYld",
                "name": "smith incline bench press",
                "targetMuscles": ["pectorals"],
                "bodyParts": ["chest"],
                "equipments": ["smith machine"],
                "secondaryMuscles": ["shoulders", "triceps"],
                "instructions": ["Adjust the bench to a 30-45 degree incline.", "Sit on the bench with your back flat against the pad and feet firmly on the ground.", "Grasp the barbell with an overhand grip slightly wider than shoulder-width apart.", "Unrack the barbell and lower it slowly towards your upper chest, keeping your elbows slightly tucked in.", "Pause for a moment at the bottom, then push the barbell back up to the starting position, fully extending your arms.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "6bOA1Oi",
                "name": "weighted side bend (on stability ball)",
                "targetMuscles": ["abs"],
                "bodyParts": ["waist"],
                "equipments": ["weighted"],
                "secondaryMuscles": ["obliques", "lower back"],
                "instructions": ["Sit on a stability ball with your feet shoulder-width apart and flat on the ground.", "Hold a weight in one hand and place your other hand on your hip.", "Engage your core and slowly bend sideways towards the weighted side, keeping your back straight.", "Pause for a moment at the bottom, then slowly return to the starting position.", "Repeat for the desired number of repetitions, then switch sides."]
            },
            {
                "exerciseId": "6cKQC5E",
                "name": "dumbbell one arm upright row",
                "targetMuscles": ["delts"],
                "bodyParts": ["shoulders"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["traps", "biceps"],
                "instructions": ["Stand with your feet shoulder-width apart, holding a dumbbell in one hand with an overhand grip.", "Let the dumbbell hang at arm's length in front of your thighs, with your palm facing your body.", "Keeping your back straight and your core engaged, exhale and lift the dumbbell straight up towards your chin, leading with your elbow.", "Pause for a moment at the top, then inhale and slowly lower the dumbbell back down to the starting position.", "Repeat for the desired number of repetitions, then switch to the other arm."]
            },
            {
                "exerciseId": "6HiHHe0",
                "name": "barbell standing rocking leg calf raise",
                "targetMuscles": ["calves"],
                "bodyParts": ["lower legs"],
                "equipments": ["barbell"],
                "secondaryMuscles": ["hamstrings", "quadriceps"],
                "instructions": ["Stand with your feet shoulder-width apart and hold a barbell across your upper back.", "Raise your heels off the ground as high as possible, balancing on the balls of your feet.", "Slowly lower your heels back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "6kSxYnw",
                "name": "barbell wrist curl v. 2",
                "targetMuscles": ["forearms"],
                "bodyParts": ["lower arms"],
                "equipments": ["barbell"],
                "secondaryMuscles": ["biceps", "brachialis"],
                "instructions": ["Sit on a bench with your feet flat on the ground and your knees bent.", "Hold a barbell with an underhand grip, palms facing up, and your hands shoulder-width apart.", "Rest your forearms on your thighs, allowing your wrists to hang off the edge.", "Slowly curl your wrists upward, bringing the barbell towards your forearms.", "Pause for a moment at the top, then slowly lower the barbell back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "6MfS53i",
                "name": "dumbbell lying single extension",
                "targetMuscles": ["triceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["shoulders"],
                "instructions": ["Lie flat on a bench with a dumbbell in one hand and your arm fully extended above your chest.", "Lower the dumbbell in a controlled manner towards your forehead, keeping your upper arm stationary.", "Pause briefly at the bottom of the movement, then extend your arm back to the starting position.", "Repeat for the desired number of repetitions, then switch arms."]
            },
            {
                "exerciseId": "6sMAmNv",
                "name": "dumbbell reverse spider curl",
                "targetMuscles": ["biceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["forearms"],
                "instructions": ["Stand up straight with a dumbbell in each hand, palms facing your body and arms fully extended.", "Keeping your upper arms stationary, exhale and curl the weights while contracting your biceps.", "Continue to raise the dumbbells until your biceps are fully contracted and the dumbbells are at shoulder level.", "Hold the contracted position for a brief pause as you squeeze your biceps.", "Inhale and slowly begin to lower the dumbbells back to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "6sYyrRX",
                "name": "bent knee lying twist (male)",
                "targetMuscles": ["glutes"],
                "bodyParts": ["upper legs"],
                "equipments": ["body weight"],
                "secondaryMuscles": ["obliques", "hip flexors"],
                "instructions": ["Lie flat on your back with your knees bent and feet flat on the ground.", "Extend your arms out to the sides, perpendicular to your body.", "Keeping your knees together, slowly lower them to one side, aiming to touch the ground with your knees.", "Pause for a moment, then engage your core and slowly lift your knees back to the starting position.", "Repeat the movement to the other side.", "Continue alternating sides for the desired number of repetitions."]
            },
            {
                "exerciseId": "7F1DVzn",
                "name": "lever front pulldown",
                "targetMuscles": ["lats"],
                "bodyParts": ["back"],
                "equipments": ["leverage machine"],
                "secondaryMuscles": ["biceps", "rhomboids", "rear deltoids"],
                "instructions": ["Adjust the seat height and position yourself on the machine with your knees under the pads and your feet flat on the ground.", "Grasp the handles with an overhand grip, slightly wider than shoulder-width apart.", "Sit upright with your chest lifted and your shoulders back, maintaining a slight arch in your lower back.", "Engage your lats and pull the handles down towards your chest, squeezing your shoulder blades together.", "Pause for a moment at the bottom of the movement, then slowly release the handles back to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "7I6LNUG",
                "name": "lever seated row",
                "targetMuscles": ["upper back"],
                "bodyParts": ["back"],
                "equipments": ["leverage machine"],
                "secondaryMuscles": ["biceps", "forearms"],
                "instructions": ["Adjust the seat height and footrests to a comfortable position.", "Sit on the machine with your chest against the pad and your feet on the footrests.", "Grasp the handles with an overhand grip, shoulder-width apart.", "Keep your back straight and your core engaged.", "Pull the handles towards your body, squeezing your shoulder blades together.", "Pause for a moment at the peak of the movement.", "Slowly release the handles and return to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "7inpWch",
                "name": "dumbbell standing concentration curl",
                "targetMuscles": ["biceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["forearms"],
                "instructions": ["Stand with your feet shoulder-width apart and hold a dumbbell in one hand, with your arm fully extended and palm facing inwards.", "Place your opposite hand on your thigh for support.", "Keeping your upper arm stationary, exhale and curl the dumbbell towards your shoulder by contracting your biceps.", "Continue to raise the dumbbell until your biceps are fully contracted and the dumbbell is at shoulder level.", "Hold the contracted position for a brief pause as you squeeze your biceps.", "Inhale and slowly lower the dumbbell back to the starting position.", "Repeat for the desired number of repetitions, then switch arms."]
            },
            {
                "exerciseId": "7saC5zz",
                "name": "cable decline fly",
                "targetMuscles": ["pectorals"],
                "bodyParts": ["chest"],
                "equipments": ["cable"],
                "secondaryMuscles": ["shoulders", "triceps"],
                "instructions": ["Adjust the cable machine to a decline position.", "Stand facing away from the machine with your feet shoulder-width apart.", "Hold the handles with your palms facing forward and your arms extended straight out in front of you.", "Keeping a slight bend in your elbows, open your arms out to the sides in a controlled motion.", "Pause for a moment at the fully extended position, then slowly return to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "7zdxRTl",
                "name": "smith leg press",
                "targetMuscles": ["glutes"],
                "bodyParts": ["upper legs"],
                "equipments": ["smith machine"],
                "secondaryMuscles": ["quadriceps", "hamstrings", "calves"],
                "instructions": ["Adjust the seat and footplate of the smith machine to a comfortable position.", "Sit on the machine with your back against the backrest and your feet shoulder-width apart on the footplate.", "Grasp the handles or sides of the machine for stability.", "Push the footplate away from you by extending your legs, keeping your back against the backrest.", "Pause for a moment at the fully extended position.", "Slowly bend your knees and lower the footplate back towards you, returning to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "8eqjhOl",
                "name": "dumbbell palms in incline bench press",
                "targetMuscles": ["triceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["dumbbell"],
                "secondaryMuscles": ["chest", "shoulders"],
                "instructions": ["Set up an incline bench at a 45-degree angle.", "Sit on the bench with your back against the backrest and feet flat on the ground.", "Hold a dumbbell in each hand with an overhand grip, palms facing inwards.", "Extend your arms straight up above your chest, keeping a slight bend in your elbows.", "Lower the dumbbells slowly towards your shoulders, keeping your elbows close to your body.", "Pause for a moment at the bottom, then press the dumbbells back up to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "8K0w2yA",
                "name": "assisted hanging knee raise with throw down",
                "targetMuscles": ["abs"],
                "bodyParts": ["waist"],
                "equipments": ["assisted"],
                "secondaryMuscles": ["hip flexors", "lower back"],
                "instructions": ["Hang from a pull-up bar with your arms fully extended and your palms facing away from you.", "Engage your core and lift your knees towards your chest, keeping your legs together.", "Once your knees are at chest level, explosively throw your legs down towards the ground, extending them fully.", "Allow your legs to swing back up and repeat the movement for the desired number of repetitions."]
            },
            {
                "exerciseId": "8oYqOt9",
                "name": "cable seated curl",
                "targetMuscles": ["biceps"],
                "bodyParts": ["upper arms"],
                "equipments": ["cable"],
                "secondaryMuscles": ["forearms"],
                "instructions": ["Sit on a cable machine with your feet flat on the ground and your back straight.", "Grasp the cable attachment with an underhand grip, palms facing up, and your arms fully extended.", "Keeping your upper arms stationary, exhale and curl the cable attachment towards your shoulders, contracting your biceps.", "Pause for a moment at the top of the movement, squeezing your biceps.", "Inhale and slowly lower the cable attachment back to the starting position, fully extending your arms.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "8ozhUIZ",
                "name": "barbell standing calf raise",
                "targetMuscles": ["calves"],
                "bodyParts": ["lower legs"],
                "equipments": ["barbell"],
                "secondaryMuscles": ["hamstrings", "glutes"],
                "instructions": ["Stand with your feet shoulder-width apart and place a barbell across your upper back.", "Raise your heels off the ground as high as possible, using only your toes.", "Pause for a moment at the top, then slowly lower your heels back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "8urJS9b",
                "name": "weighted hyperextension (on stability ball)",
                "targetMuscles": ["spine"],
                "bodyParts": ["back"],
                "equipments": ["weighted"],
                "secondaryMuscles": ["glutes", "hamstrings"],
                "instructions": ["Position yourself face down on a stability ball with your hips resting on the ball and your feet against a wall for stability.", "Place your hands behind your head or cross them over your chest.", "Engage your core and slowly lift your upper body off the ball, extending your back until your body forms a straight line.", "Pause for a moment at the top, then slowly lower your upper body back down to the starting position.", "Repeat for the desired number of repetitions."]
            },
            {
                "exerciseId": "8xUv4J7",
                "name": "cable seated crunch",
                "targetMuscles": ["abs"],
                "bodyParts": ["waist"],
                "equipments": ["cable"],
                "secondaryMuscles": ["obliques"],
                "instructions": ["Sit on a cable machine with your feet flat on the ground and your knees bent.", "Hold the cable handle with both hands and position it behind your head.", "Engage your abs and slowly curl your upper body forward, bringing your chest towards your knees.", "Pause for a moment at the top, then slowly return to the starting position.", "Repeat for the desired number of repetitions."]
            }
        ];

        const SamplePackClassifier = {
            convertSamplePackExercises() {
                return SAMPLE_PACK_EXERCISES.map(exercise => {
                    const threeAnchorExercise = this.classifyForThreeAnchor(exercise);
                    return {
                        ...threeAnchorExercise,
                        source: 'sample_pack',
                        exerciseId: exercise.exerciseId,
                        originalData: exercise
                    };
                });
            },
            
            classifyForThreeAnchor(exercise) {
                const name = exercise.name.toLowerCase();
                const equipment = exercise.equipments[0] || 'body weight';
                const targetMuscles = exercise.targetMuscles;
                const bodyParts = exercise.bodyParts;
                
                // Determine classification based on exercise characteristics
                let classification, adaptation, component, cns, sets, reps, load, rest;
                
                // Max Effort exercises (compound, heavy)
                if (this.isMaxEffort(name, equipment)) {
                    classification = "Max Effort";
                    adaptation = "Relative Strength";
                    component = "relative strength";
                    cns = this.calculateCNS(name, equipment, 'max_effort');
                    sets = 3;
                    reps = name.includes('pistol') ? 5 : 4; // Single leg exercises get more reps
                    load = "85% 1RM / RPE 9";
                    rest = "3-4min";
                }
                // Dynamic Effort exercises (explosive, power)
                else if (this.isDynamicEffort(name)) {
                    classification = "Dynamic Effort";
                    adaptation = "Power";
                    component = "power";
                    cns = this.calculateCNS(name, equipment, 'dynamic_effort');
                    sets = 4;
                    reps = 5;
                    load = "Bodyweight / 100% intent";
                    rest = "2min";
                }
                // Submaximal Effort exercises (moderate intensity compounds)
                else if (this.isSubmaximalEffort(name, equipment)) {
                    classification = "Submaximal Effort";
                    adaptation = "Functional Hypertrophy";
                    component = "functional hypertrophy";
                    cns = this.calculateCNS(name, equipment, 'submaximal_effort');
                    sets = 3;
                    reps = 6;
                    load = "80% 1RM / RPE 8";
                    rest = "2-3min";
                }
                // Repetition Effort exercises (isolation, higher volume)
                else {
                    classification = "Repetition Effort";
                    adaptation = "Strength Endurance";
                    component = "strength endurance";
                    cns = this.calculateCNS(name, equipment, 'repetition_effort');
                    sets = 2;
                    reps = "15-20";
                    load = "70% effort / RPE 7-8";
                    rest = "30-60s";
                }
                
                return {
                    name: exercise.name,
                    classification: classification,
                    adaptation: adaptation,
                    component: component,
                    cns: cns,
                    sets: sets,
                    reps: reps,
                    load: load,
                    rest: rest,
                    notes: exercise.instructions[0] || "Focus on proper form and controlled movement",
                    equipment: exercise.equipments,
                    bodyParts: exercise.bodyParts,
                    targetMuscles: exercise.targetMuscles
                };
            },
            
            isMaxEffort(name, equipment) {
                // Heavy compound movements
                const maxEffortKeywords = ['bench press', 'incline bench', 'pistol squat', 'leg press'];
                return maxEffortKeywords.some(keyword => name.includes(keyword));
            },
            
            isDynamicEffort(name) {
                // Explosive or power movements
                const dynamicKeywords = ['impossible dips', 'pistol squat'];
                return dynamicKeywords.some(keyword => name.includes(keyword)) && name.includes('explosive');
            },
            
            isSubmaximalEffort(name, equipment) {
                // Moderate intensity compounds and machine work
                const submaximalKeywords = ['pulldown', 'seated row', 'lever', 'smith', 'upright row'];
                return submaximalKeywords.some(keyword => name.includes(keyword));
            },
            
            calculateCNS(name, equipment, classification) {
                let baseCNS = {
                    'max_effort': 8,
                    'dynamic_effort': 7,
                    'submaximal_effort': 6,
                    'repetition_effort': 3
                }[classification] || 4;
                
                // Adjust based on exercise characteristics
                if (name.includes('press') && name.includes('bench')) baseCNS += 1;
                if (name.includes('pistol')) baseCNS += 2; // Single leg is very demanding
                if (name.includes('impossible')) baseCNS += 1; // Advanced bodyweight
                if (name.includes('curl') || name.includes('raise')) baseCNS -= 1; // Isolation
                if (name.includes('calf') || name.includes('wrist')) baseCNS -= 2; // Small muscle groups
                
                return Math.max(1, Math.min(10, baseCNS));
            }
        };

        // ==================== EXERCISEDB INTEGRATION LAYER ====================
        
        const ExerciseDBManager = {
            cached_exercises: null,
            loading: false,
            
            async loadExercises() {
                if (this.cached_exercises) return this.cached_exercises;
                
                console.log('Loading exercises: Original + Sample Pack...');
                
                // Get original exercises
                const originalExercises = this.getOriginalExercises();
                
                // Get sample pack exercises
                const samplePackExercises = SamplePackClassifier.convertSamplePackExercises();
                
                // Combine all exercises
                this.cached_exercises = [...originalExercises, ...samplePackExercises];
                
                console.log(`Total exercise database: ${this.cached_exercises.length} exercises`);
                console.log(`- Original Three Anchor: ${originalExercises.length} exercises`);
                console.log(`- Sample Pack: ${samplePackExercises.length} exercises`);
                
                return this.cached_exercises;
            },
            
            enhanceWithThreeAnchor(exerciseDBData) {
                return exerciseDBData.map(exercise => {
                    const enhanced = ThreeAnchorClassifier.classify(exercise);
                    return {
                        ...enhanced,
                        source: 'exercisedb',
                        original_data: exercise
                    };
                }).filter(ex => ex.classification); // Only include successfully classified exercises
            },
            
            getOriginalExercises() {
                // Convert original exercise database to array format
                return Object.values(ME_DE_SE_RE_EXERCISES).map(ex => ({
                    ...ex,
                    source: 'original',
                    exerciseId: ex.name.toLowerCase().replace(/\s+/g, '_')
                }));
            },
            
            filterByEquipment(exercises, equipment) {
                if (equipment === 'full-gym') return exercises;
                if (equipment === 'bodyweight') {
                    return exercises.filter(ex => 
                        ex.source === 'original' || // Keep all original exercises
                        !ex.equipment || 
                        ex.equipment.includes('bodyweight') ||
                        ex.equipment.includes('none') ||
                        ex.classification?.includes('Isometric')
                    );
                }
                if (equipment === 'basic') {
                    return exercises.filter(ex => 
                        ex.source === 'original' || // Keep all original exercises
                        !ex.equipment || 
                        ex.equipment.includes('dumbbell') ||
                        ex.equipment.includes('bodyweight') ||
                        ex.equipment.includes('resistance band')
                    );
                }
                return exercises;
            }
        };
        
        const ThreeAnchorClassifier = {
            classify(exerciseDBExercise) {
                const name = exerciseDBExercise.name || '';
                const category = exerciseDBExercise.category || '';
                const equipment = exerciseDBExercise.equipments || exerciseDBExercise.equipment || [];
                const bodyParts = exerciseDBExercise.bodyParts || [];
                const targetMuscles = exerciseDBExercise.targetMuscles || [];
                
                // Determine component and classification based on exercise characteristics
                const analysis = this.analyzeExercise(name, category, equipment, bodyParts);
                
                return {
                    exerciseId: exerciseDBExercise.exerciseId || name.toLowerCase().replace(/\s+/g, '_'),
                    name: name,
                    classification: analysis.classification,
                    adaptation: analysis.adaptation,
                    component: analysis.component,
                    cns: analysis.cns,
                    sets: analysis.sets,
                    reps: analysis.reps,
                    load: analysis.load,
                    rest: analysis.rest,
                    notes: this.generateNotes(exerciseDBExercise),
                    equipment: Array.isArray(equipment) ? equipment : [equipment],
                    bodyParts: bodyParts,
                    targetMuscles: targetMuscles
                };
            },
            
            analyzeExercise(name, category, equipment, bodyParts) {
                const nameLower = name.toLowerCase();
                
                // Max Effort Classification (85-100% loads)
                if (this.isMaxEffort(nameLower, category)) {
                    return {
                        classification: "Max Effort",
                        adaptation: "Relative Strength",
                        component: "relative strength",
                        cns: this.calculateCNS(nameLower, 'max_effort'),
                        sets: 3, reps: 5,
                        load: "85% 1RM / RPE 9",
                        rest: "3-4min"
                    };
                }
                
                // Dynamic Effort Classification (Explosive/Power)
                if (this.isDynamicEffort(nameLower, category)) {
                    return {
                        classification: "Dynamic Effort",
                        adaptation: "Power",
                        component: "power",
                        cns: this.calculateCNS(nameLower, 'dynamic_effort'),
                        sets: 4, reps: 5,
                        load: "Bodyweight / 100% intent",
                        rest: "2-3min"
                    };
                }
                
                // Submaximal Effort Classification (75-85%)
                if (this.isSubmaximalEffort(nameLower, category)) {
                    return {
                        classification: "Submaximal Effort",
                        adaptation: "Functional Hypertrophy",
                        component: "functional hypertrophy",
                        cns: this.calculateCNS(nameLower, 'submaximal_effort'),
                        sets: 3, reps: 6,
                        load: "80% 1RM / RPE 8",
                        rest: "2-3min"
                    };
                }
                
                // Repetition Effort Classification (60-75% to failure)
                return {
                    classification: "Repetition Effort",
                    adaptation: "Strength Endurance",
                    component: "strength endurance",
                    cns: this.calculateCNS(nameLower, 'repetition_effort'),
                    sets: 2, reps: "15-20",
                    load: "70% effort / RPE 7-8",
                    rest: "30-60s"
                };
            },
            
            isMaxEffort(name, category) {
                const maxEffortKeywords = [
                    'deadlift', 'squat', 'bench press', 'overhead press',
                    'clean', 'snatch', 'jerk', '1rm', 'max'
                ];
                return maxEffortKeywords.some(keyword => name.includes(keyword));
            },
            
            isDynamicEffort(name, category) {
                const dynamicKeywords = [
                    'jump', 'explosive', 'power', 'sprint', 'throw',
                    'slam', 'clap', 'speed', 'plyo', 'bounce'
                ];
                return dynamicKeywords.some(keyword => name.includes(keyword));
            },
            
            isSubmaximalEffort(name, category) {
                const submaximalKeywords = [
                    'tempo', 'pause', 'pin press', 'box squat',
                    'front squat', 'incline', 'decline', 'lunge', 'row'
                ];
                return submaximalKeywords.some(keyword => name.includes(keyword));
            },
            
            calculateCNS(name, classification) {
                let baseCNS = {
                    'max_effort': 8,
                    'dynamic_effort': 7,
                    'submaximal_effort': 6,
                    'repetition_effort': 3
                }[classification] || 4;
                
                // Adjust based on exercise characteristics
                if (name.includes('deadlift')) baseCNS += 2;
                if (name.includes('squat')) baseCNS += 1;
                if (name.includes('sprint')) baseCNS += 2;
                if (name.includes('isolation') || name.includes('curl')) baseCNS -= 2;
                
                return Math.max(1, Math.min(10, baseCNS));
            },
            
            generateNotes(exercise) {
                const instructions = exercise.instructions || [];
                if (instructions.length > 0) {
                    return instructions[0]; // Use first instruction as note
                }
                return "Focus on proper form and controlled movement";
            }
        };

        // ==================== ORIGINAL ME/DE/SE/RE EXERCISE DATABASE ====================
        
        const ME_DE_SE_RE_EXERCISES = {
            // MAX EFFORT EXERCISES (85-100% 1RM)
            back_squat: {
                name: "Back Squat",
                classification: "Max Effort",
                adaptation: "Relative Strength",
                component: "relative strength",
                cns: 9,
                sets: 3, reps: 5,
                load: "85% 1RM / RPE 9",
                rest: "3-4min",
                notes: "Full depth, drive through heels, controlled eccentric"
            },
            bench_press: {
                name: "Bench Press", 
                classification: "Max Effort",
                adaptation: "Relative Strength",
                component: "relative strength",
                cns: 6,
                sets: 3, reps: 4,
                load: "85% 1RM / RPE 9",
                rest: "3-4min",
                notes: "Pause on chest, drive with legs, controlled eccentric"
            },
            deadlift: {
                name: "Deadlift",
                classification: "Max Effort", 
                adaptation: "Relative Strength",
                component: "relative strength",
                cns: 10,
                sets: 3, reps: 3,
                load: "90% 1RM / RPE 9-10",
                rest: "4-5min",
                notes: "Hip hinge, neutral spine, drive through heels"
            },
            
            // DYNAMIC EFFORT EXERCISES (Explosive Intent)
            power_clean: {
                name: "Power Clean",
                classification: "Dynamic Effort",
                adaptation: "Power", 
                component: "power",
                cns: 10,
                sets: 5, reps: 2,
                load: "75% 1RM / 100% intent",
                rest: "3min",
                notes: "Maximum bar speed, catch in quarter squat"
            },
            jump_squat: {
                name: "Jump Squats",
                classification: "Dynamic Effort",
                adaptation: "Power",
                component: "power", 
                cns: 7,
                sets: 4, reps: 5,
                load: "Bodyweight / 100% intent",
                rest: "2min",
                notes: "Explosive up, soft landing, full reset between reps"
            },
            med_ball_slam: {
                name: "Medicine Ball Slam",
                classification: "Dynamic Effort",
                adaptation: "Power",
                component: "power",
                cns: 6,
                sets: 4, reps: 6,
                load: "10kg ball / 90% max effort",
                rest: "90s",
                notes: "Overhead to floor, pick up and reset each rep"
            },
            
            // SUBMAXIMAL EFFORT EXERCISES (75-85% 1RM)
            rfe_squat: {
                name: "RFE Squat",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 6,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Upright torso, full ROM"
            },
            barbell_incline: {
                name: "Barbell Incline Press",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 6,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Control descent, pause between reps"
            },
            walking_lunge: {
                name: "Walking Lunge",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 6,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Upright torso, big lunge forward"
            },
            romanian_deadlift: {
                name: "Romanian Deadlift (RDL)",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 8,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Clean grip, upright torso, drive elbows up"
            },
            overhead_press: {
                name: "Overhead Press",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 5,
                sets: 3, reps: 8,
                load: "75% 1RM / RPE 7-8", 
                rest: "1-2min",
                notes: "Controlled eccentric, full ROM"
            },
            db_row: {
                name: "Single-Arm DB Row",
                classification: "Submaximal Effort",
                adaptation: "Hypertrophy",
                component: "hypertrophy",
                cns: 3,
                sets: 3, reps: "12",
                load: "70% effort / RPE 7-8",
                rest: "90s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            barbell_row: {
                name: "BB Row",
                classification: "Submaximal Effort",
                adaptation: "Hypertrophy",
                component: "hypertrophy",
                cns: 3,
                sets: 3, reps: "12",
                load: "70% effort / RPE 7-8",
                rest: "90s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            supported_row: {
                name: "Chest Supported Row",
                classification: "Submaximal Effort",
                adaptation: "Hypertrophy",
                component: "hypertrophy",
                cns: 3,
                sets: 3, reps: "12",
                load: "70% effort / RPE 7-8",
                rest: "90s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            // REPETITION EFFORT EXERCISES (60-75% to failure)
            bicep_curl: {
                name: "Bicep Curl",
                classification: "Repetition Effort",
                adaptation: "Strength Endurance",
                component: "strength endurance",
                cns: 3,
                sets: 2, reps: "15-20",
                load: "70% effort / RPE 7-8",
                rest: "30-60s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            tricep_extension: {
                name: "Tricep Extension",
                classification: "Repetition Effort", 
                adaptation: "Strength Endurance",
                component: "strength endurance",
                cns: 4,
                sets: 2, reps: "15-20",
                load: "RPE 7-8",
                rest: "30-60s",
                notes: "Squeeze at bottom, keep elbows tight"
            },
            shoulder_fly: {
                name: "DB Shoulder Fly",
                classification: "Repetition Effort", 
                adaptation: "Strength Endurance",
                component: "strength endurance",
                cns: 4,
                sets: 2, reps: "15-20",
                load: "RPE 7-8",
                rest: "30-60s",
                notes: "Squeeze at bottom, keep elbows tight"
            },
            // BODYWEIGHT MAX EFFORT ALTERNATIVES
            doorway_squat_hold: {
                name: "Doorway Single-Leg Squat Hold",
                classification: "Max Effort",
                adaptation: "Unilateral Strength",
                component: "relative strength",
                cns: 7,
                sets: 4, reps: "10-sec holds each leg",
                load: "100% max effort isometric",
                rest: "2min",
                notes: "90° knee angle against doorframe, maximum force production"
            },
            doorway_chest_push: {
                name: "Doorway Chest Push (Isometric)", 
                classification: "Max Effort",
                adaptation: "Upper Body Strength",
                component: "relative strength",
                cns: 6,
                sets: 4, reps: "8-sec holds",
                load: "100% max effort against immovable object",
                rest: "2min",
                notes: "Chest-height against doorframe, maximum force production"
            },
            
            // SPEED/SAQ COMPONENTS
            sprint_20m: {
                name: "20m Sprints",
                classification: "Alactic Power",
                adaptation: "Neural Power",
                component: "speed",
                cns: 10,
                sets: 5, reps: 3,
                load: "95-100% max velocity",
                rest: "3-4min",
                notes: "Maximum velocity, full recovery between reps"
            },
            agility_ladder: {
                name: "Agility Ladder (Multi-directional)",
                classification: "Alactic Power", 
                adaptation: "Neural Coordination",
                component: "speed",
                cns: 8,
                sets: 6, reps: "15sec",
                load: "100% max effort",
                rest: "2min", 
                notes: "Change direction patterns each set"
            },
            
            // RECOVERY/CONDITIONING COMPONENTS
            tempo_run: {
                name: "Tempo Runs",
                classification: "Submaximal Effort",
                adaptation: "Aerobic Base",
                component: "conditioning",
                cns: 3,
                sets: 1, reps: "15min",
                load: "70-75% effort / HR Zone 2",
                rest: "N/A",
                notes: "Nasal breathing, conversational pace"
            },
            mobility_flow: {
                name: "Dynamic Mobility Flow",
                classification: "Repetition Effort",
                adaptation: "Movement Quality",
                component: "mobility", 
                cns: 1,
                sets: 2, reps: "10 each direction",
                load: "Bodyweight / RPE 3-4",
                rest: "minimal",
                notes: "Full ROM, controlled movements, focus on quality"
            }
        };

        // ==================== ORIGINAL PROGRAM TEMPLATES WITH PROPER VERTICAL INTEGRATION ====================
        
        const PROGRAM_TEMPLATES = {
            // 3-Day High-Low Pattern (H-L-H-L-H-L-L)
            strength_focus_3day: {
                title: "3-Day Vertical Integration - Strength Focus",
                monday: {
                    type: "high",
                    focus: "Full Vertical Integration - Workout A",
                    exercises: [
                        // SPEED (Highest Neural, Highest Risk)
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m},
                        // POWER (Explosive Effort)
                        {...ME_DE_SE_RE_EXERCISES.jump_squat},
                        // RELATIVE STRENGTH (Max Effort Primary)
                        {...ME_DE_SE_RE_EXERCISES.back_squat},
                        // FUNCTIONAL HYPERTROPHY (Submaximal Effort Secondary)
                        {...ME_DE_SE_RE_EXERCISES.barbell_incline},
                        // HYPERTROPHY (Submaximal Effort Auxiliary)
                        {...ME_DE_SE_RE_EXERCISES.supported_row},
                        // STRENGTH ENDURANCE (Repetition Effort Isolation, Lowest Neural, Most Metabolic)
                        {...ME_DE_SE_RE_EXERCISES.bicep_curl}
                    ]
                },
                tuesday: {
                    type: "low", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                        // Low days: Tempo/Recovery focus only
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                wednesday: {
                    type: "high",
                    focus: "Full Vertical Integration - Workout B", 
                    exercises: [
                        // SPEED
                        {...ME_DE_SE_RE_EXERCISES.agility_ladder},
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.power_clean},
                        // RELATIVE STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.bench_press},
                        // FUNCTIONAL HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.rfe_squat},
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.db_row},
                        // STRENGTH ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.tricep_extension}
                    ]
                },
                thursday: {
                    type: "low", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                        // Low days: Tempo/Recovery focus only
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                friday: {
                    type: "high",
                    focus: "Full Vertical Integration - Workout C", 
                    exercises: [
                        // SPEED
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m},
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.power_clean},
                        // RELATIVE STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.deadlift},
                        // FUNCTIONAL HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.overhead_press},
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.barbell_row},
                        // STRENGTH ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.shoulder_fly}
                    ]
                },
                saturday: {
                    type: "low", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                        // Low days: Tempo/Recovery focus only
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                sunday: {
                    type: "off", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                    ]
                }
            },

            // 4-Day High-Low Pattern (H-M-L-H-L-L-L) - Upper/Lower Split
            strength_focus_4day: {
                title: "4-Day Upper/Lower - Vertical Integration",
                monday: {
                    type: "high",
                    focus: "Lower Body - Full Vertical Integration",
                    exercises: [
                        // SPEED
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m},
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.jump_squat},
                        // STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.back_squat},
                        {...ME_DE_SE_RE_EXERCISES.deadlift, sets: 2, reps: 2}, // Reduced volume
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.walking_lunge},
                        // ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                tuesday: {
                    type: "medium",
                    focus: "Upper Body - Recovery Base + Upper Lift",
                    exercises: [
                        // Medium day = Low day foundation + upper body strength work
                        {...ME_DE_SE_RE_EXERCISES.tempo_run, reps: "10min"}, // Shorter tempo
                        {...ME_DE_SE_RE_EXERCISES.bench_press, sets: 3, load: "80% 1RM / RPE 7"}, // Single upper lift
                        {...ME_DE_SE_RE_EXERCISES.db_row, sets: 3},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                wednesday: {
                    type: "low",
                    focus: "Complete Recovery",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow, sets: 3}
                    ]
                },
                thursday: {
                    type: "high",
                    focus: "Upper Body - Full Vertical Integration",
                    exercises: [
                        // SPEED (Upper body speed work)
                        {...ME_DE_SE_RE_EXERCISES.agility_ladder, sets: 4, cns: 6}, // Reduced for upper focus
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.med_ball_slam},
                        {...ME_DE_SE_RE_EXERCISES.power_clean}, 
                        // STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.bench_press},
                        {...ME_DE_SE_RE_EXERCISES.barbell_incline},
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.db_row},
                        // ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                }
            },

            power_focus: {
                title: "Dynamic Effort Power Focus",
                monday: {
                    type: "high",
                    focus: "Speed + Dynamic Effort",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m, sets: 6},
                        {...ME_DE_SE_RE_EXERCISES.power_clean, sets: 6},
                        {...ME_DE_SE_RE_EXERCISES.jump_squat, sets: 5},
                        {...ME_DE_SE_RE_EXERCISES.med_ball_slam, sets: 5},
                        {...ME_DE_SE_RE_EXERCISES.back_squat, sets: 3, load: "75% 1RM / RPE 7"}
                    ]
                },
                tuesday: {
                    type: "low",
                    focus: "Recovery + Strength Maintenance",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.tempo_run, reps: "12min"},
                        {...ME_DE_SE_RE_EXERCISES.rfe_squat, sets: 3, load: "70% 1RM / RPE 6"},
                        {...ME_DE_SE_RE_EXERCISES.barbell_incline, sets: 3, load: "70% 1RM / RPE 6"},
                        {...ME_DE_SE_RE_EXERCISES.db_row, sets: 3}
                    ]
                },
                thursday: {
                    type: "high",
                    focus: "Power + Agility",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.agility_ladder, sets: 8},
                        {...ME_DE_SE_RE_EXERCISES.jump_squat, sets: 6, reps: 3},
                        {...ME_DE_SE_RE_EXERCISES.med_ball_slam, sets: 6},
                        {...ME_DE_SE_RE_EXERCISES.deadlift, sets: 3, load: "80% 1RM / RPE 8"},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                }
            },
            
            bodyweight_only: {
                title: "Bodyweight High-Low with Isometric Max Effort",
                monday: {
                    type: "high",
                    focus: "Max Effort Isometrics + Power",
                    exercises: [
                        {
                            name: "Hill Sprints",
                            classification: "Alactic Power",
                            adaptation: "Neural Power", 
                            component: "speed",
                            cns: 9,
                            sets: 5, reps: "20yd",
                            load: "100% max effort uphill",
                            rest: "3min",
                            notes: "Focus on drive phase, walk down recovery"
                        },
                        {...ME_DE_SE_RE_EXERCISES.jump_squat},
                        {...ME_DE_SE_RE_EXERCISES.doorway_squat_hold},
                        {...ME_DE_SE_RE_EXERCISES.doorway_chest_push},
                        {
                            name: "Single-leg Glute Bridge Hold",
                            classification: "Max Effort",
                            adaptation: "Posterior Chain Strength",
                            component: "relative strength",
                            cns: 6,
                            sets: 3, reps: "15-sec holds each leg", 
                            load: "100% max effort",
                            rest: "2min",
                            notes: "Maximum glute contraction, hold at top"
                        }
                    ]
                },
                tuesday: {
                    type: "low",
                    focus: "Repetition Effort + Recovery",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {
                            name: "Push-ups (High Volume)",
                            classification: "Repetition Effort",
                            adaptation: "Upper Body Hypertrophy",
                            component: "hypertrophy",
                            cns: 3,
                            sets: 4, reps: "15-25",
                            load: "RPE 7-8",
                            rest: "90s",
                            notes: "Modify angle as needed, focus on time under tension"
                        },
                        {...ME_DE_SE_RE_EXERCISES.walking_lunge, sets: 4, reps: "15 each leg", name: "Bodyweight Lunges"},
                        {
                            name: "Pike Push-ups",
                            classification: "Repetition Effort", 
                            adaptation: "Shoulder Hypertrophy",
                            component: "hypertrophy",
                            cns: 4,
                            sets: 3, reps: "8-12",
                            load: "RPE 7-8",
                            rest: "90s",
                            notes: "Feet elevated if possible, focus on shoulders"
                        }
                    ]
                },
                thursday: {
                    type: "high",
                    focus: "Dynamic Effort + Unilateral Strength",
                    exercises: [
                        {
                            name: "Broad Jumps",
                            classification: "Dynamic Effort",
                            adaptation: "Horizontal Power",
                            component: "power",
                            cns: 7,
                            sets: 5, reps: 3,
                            load: "100% max intent",
                            rest: "2min",
                            notes: "Maximum distance, full reset between reps"
                        },
                        {
                            name: "Explosive Push-ups",
                            classification: "Dynamic Effort",
                            adaptation: "Upper Body Power",
                            component: "power", 
                            cns: 6,
                            sets: 4, reps: 5,
                            load: "100% max intent",
                            rest: "90s",
                            notes: "Hands leave ground, maximum explosive effort"
                        },
                        {
                            name: "Single-leg Squat (Assisted)",
                            classification: "Max Effort",
                            adaptation: "Unilateral Strength",
                            component: "relative strength",
                            cns: 7,
                            sets: 4, reps: "5 each leg",
                            load: "85-90% max effort",
                            rest: "2min",
                            notes: "Use assistance as needed, focus on full ROM"
                        },
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                }
            }
        };

        // ==================== GLOBAL VARIABLES ====================
        
        let currentPlan = null;
        let currentDay = 0;

        // ==================== ENHANCED CORE FUNCTIONS ====================
        
        async function generatePlan() {
            console.log('Generate plan called with ExerciseDB integration');
            
            // Show loading state
            document.querySelector('.btn[onclick="generatePlan()"]').classList.add('generating');
            document.querySelector('.btn[onclick="generatePlan()"]').textContent = 'Generating Program...';
            
            try {
                // Get form values
                const goal = document.getElementById('trainingGoal')?.value || 'strength';
                const split = document.getElementById('splitType')?.value || '3-day-high-low';
                const equipment = document.getElementById('equipment')?.value || 'full-gym';
                const duration = document.getElementById('duration')?.value || '60';
                const block = document.getElementById('trainingBlock')?.value || 'accumulation';
                const blockLength = document.getElementById('blockLength')?.value || '4';
                const trainingAge = document.getElementById('trainingAge')?.value || 'intermediate';

                console.log('Form values:', { goal, split, equipment, duration, block, blockLength, trainingAge });

                // Load enhanced exercise database
                const availableExercises = await ExerciseDBManager.loadExercises();
                const filteredExercises = ExerciseDBManager.filterByEquipment(availableExercises, equipment);
                
                console.log(`Working with ${filteredExercises.length} exercises for ${equipment} equipment`);

                // Select appropriate program template based on split type
                let selectedTemplate;
                if (equipment === 'bodyweight') {
                    selectedTemplate = PROGRAM_TEMPLATES.bodyweight_only;
                } else if (split === '4-day-high-low') {
                    selectedTemplate = PROGRAM_TEMPLATES.strength_focus_4day;
                } else if (goal === 'power') {
                    selectedTemplate = PROGRAM_TEMPLATES.power_focus;
                } else {
                    selectedTemplate = PROGRAM_TEMPLATES.strength_focus_3day;
                }
                
                // Generate weekly plan with enhanced exercise pool
                currentPlan = await generateEnhancedProgram(selectedTemplate, { 
                    goal, split, equipment, duration, block, blockLength, trainingAge 
                }, filteredExercises);
                
                console.log('Generated enhanced plan:', currentPlan);
                
                displayWeeklyPlan(currentPlan);
                updateStats(currentPlan);
                updateProgress();

                const exerciseCount = filteredExercises.length;
                const source = filteredExercises.some(ex => ex.source === 'exercisedb') ? 'Enhanced with ExerciseDB' : 'Original System';
                
                addChatMessage("Assistant", `Generated ${selectedTemplate.title} with proper Vertical Integration sequencing: Speed → Power → Strength → Hypertrophy → Endurance. Using ${source} (${exerciseCount} exercises available).`);
                    
            } catch (error) {
                console.error('Program generation failed:', error);
                addChatMessage("Assistant", "Program generation encountered an issue. Using original system to ensure you get a working program.");
                
                // Fallback to original system
                generateOriginalPlan();
            } finally {
                // Reset button state
                const button = document.querySelector('.btn[onclick="generatePlan()"]');
                button.classList.remove('generating');
                button.textContent = 'Generate Enhanced Program';
            }
        }
        
        async function generateEnhancedProgram(template, userInputs, availableExercises) {
            // Start with the original template structure
            const plan = adaptTemplate(template, userInputs);
            
            // Enhance with additional exercises from ExerciseDB where appropriate
            if (availableExercises.some(ex => ex.source === 'exercisedb')) {
                // Add variety by occasionally substituting with ExerciseDB exercises
                Object.keys(plan).forEach(day => {
                    if (plan[day].type === 'high' && plan[day].exercises.length > 0) {
                        // Potentially add one additional exercise from ExerciseDB
                        const additionalExercise = selectAdditionalExercise(availableExercises, plan[day].exercises, userInputs);
                        if (additionalExercise) {
                            plan[day].exercises.push(additionalExercise);
                        }
                    }
                });
            }
            
            return plan;
        }
        
        function selectAdditionalExercise(availableExercises, currentExercises, userInputs) {
            // Select an exercise from ExerciseDB that complements the current session
            const exerciseDBExercises = availableExercises.filter(ex => ex.source === 'exercisedb');
            if (exerciseDBExercises.length === 0) return null;
            
            // Calculate current CNS load
            const currentCNS = currentExercises.reduce((sum, ex) => sum + (ex.cns || 0), 0);
            const maxCNS = userInputs.trainingAge === 'beginner' ? 25 : userInputs.trainingAge === 'advanced' ? 45 : 35;
            
            // Look for a low-CNS exercise that won't overload the session
            const suitableExercises = exerciseDBExercises.filter(ex => 
                ex.cns <= 4 && (currentCNS + ex.cns) <= maxCNS
            );
            
            if (suitableExercises.length === 0) return null;
            
            // Return a random suitable exercise
            return suitableExercises[Math.floor(Math.random() * suitableExercises.length)];
        }
        
        function generateOriginalPlan() {
            // Original system as backup
            const goal = document.getElementById('trainingGoal')?.value || 'strength';
            const split = document.getElementById('splitType')?.value || '3-day-high-low';
            const equipment = document.getElementById('equipment')?.value || 'full-gym';
            
            let selectedTemplate;
            if (equipment === 'bodyweight') {
                selectedTemplate = PROGRAM_TEMPLATES.bodyweight_only;
            } else if (split === '4-day-high-low') {
                selectedTemplate = PROGRAM_TEMPLATES.strength_focus_4day;
            } else if (goal === 'power') {
                selectedTemplate = PROGRAM_TEMPLATES.power_focus;
            } else {
                selectedTemplate = PROGRAM_TEMPLATES.strength_focus_3day;
            }
            
            currentPlan = adaptTemplate(selectedTemplate, { 
                goal, equipment, 
                duration: '60', 
                block: 'accumulation', 
                trainingAge: 'intermediate' 
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            updateProgress();
        }

        function adaptTemplate(template, userInputs) {
            const plan = {};
            
            // Add Saturday and Sunday as rest days for 3-day plan
            const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            allDays.forEach(day => {
                const dayKey = day.toLowerCase();
                
                if (template[dayKey]) {
                    // Use template day
                    plan[day] = {
                        ...template[dayKey],
                        duration: userInputs.duration,
                        block: userInputs.block,
                        blockLength: userInputs.blockLength,
                        title: template.title
                    };
                    
                    // Apply user-specific adaptations
                    plan[day].exercises = plan[day].exercises.map(exercise => 
                        adaptExercise(exercise, userInputs)
                    );
                } else {
                    // Rest day
                    plan[day] = {
                        type: "rest",
                        focus: "Complete Rest",
                        exercises: [],
                        duration: 0,
                        title: "Rest Day"
                    };
                }
            });
            
            return plan;
        }

        function adaptExercise(exercise, userInputs) {
            let adapted = { ...exercise };
            
            // Training age adaptations
            if (userInputs.trainingAge === 'beginner') {
                // Reduce intensity for beginners
                if (adapted.load && adapted.load.includes('85%')) {
                    adapted.load = adapted.load.replace('85%', '75%');
                }
                if (adapted.load && adapted.load.includes('90%')) {
                    adapted.load = adapted.load.replace('90%', '80%');
                }
                // Reduce CNS for safety
                adapted.cns = Math.min(adapted.cns, 7);
            }
            
            // Phase adaptations
            if (userInputs.block === 'gpp') {
                // Increase volume, reduce intensity for GPP
                if (typeof adapted.sets === 'number') {
                    adapted.sets = Math.min(adapted.sets + 1, 6);
                }
                adapted.cns = Math.max(1, adapted.cns - 1);
            } else if (userInputs.block === 'realization') {
                // Reduce volume, increase intensity for peaking
                if (typeof adapted.sets === 'number') {
                    adapted.sets = Math.max(adapted.sets - 1, 1);
                }
                if (adapted.classification === 'Max Effort') {
                    adapted.load = adapted.load.replace('85%', '90-95%');
                }
            }
            
            return adapted;
        }

        // ==================== VERTICAL INTEGRATION RENDERING FUNCTIONS ====================

        function renderVerticalIntegrationSections(exercises, day) {
            // Group exercises by vertical integration sequence
            const speedExercises = exercises.filter(ex => ex.component === 'speed');
            const powerExercises = exercises.filter(ex => ex.component === 'power');
            const relativeStrengthExercises = exercises.filter(ex => ex.component === 'relative strength');
            const functionalHypertrophyExercises = exercises.filter(ex => ex.component === 'functional hypertrophy');
            const hypertrophyExercises = exercises.filter(ex => ex.component === 'hypertrophy');
            const strengthEnduranceExercises = exercises.filter(ex => ex.component === 'strength endurance');
            const conditioningExercises = exercises.filter(ex => ex.component === 'conditioning');
            const mobilityExercises = exercises.filter(ex => ex.component === 'mobility');
            
            let html = '';
            
            // SPEED Section (Highest Neural/Risk)
            if (speedExercises.length > 0) {
                html += `
                    <div class="exercise-section field-section">
                        <h4 class="section-header">Speed/SAQ (Neural Prime)</h4>
                        <ul class="exercise-list">
                            ${speedExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'field', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // POWER Section
            if (powerExercises.length > 0) {
                html += `
                    <div class="exercise-section field-section">
                        <h4 class="section-header">Power/Explosive</h4>
                        <ul class="exercise-list">
                            ${powerExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'field', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // RELATIVE STRENGTH Section
            if (relativeStrengthExercises.length > 0) {
                html += `
                    <div class="exercise-section lifting-section">
                        <h4 class="section-header">Relative Strength Work</h4>
                        <ul class="exercise-list">
                            ${relativeStrengthExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'lifting', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // FUNCTIONAL HYPERTROPHY Section
            if (functionalHypertrophyExercises.length > 0) {
                html += `
                    <div class="exercise-section lifting-section">
                        <h4 class="section-header">Functional Hypertrophy</h4>
                        <ul class="exercise-list">
                            ${functionalHypertrophyExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'lifting', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // HYPERTROPHY Section
            if (hypertrophyExercises.length > 0) {
                html += `
                    <div class="exercise-section">
                        <h4 class="section-header">Hypertrophy</h4>
                        <ul class="exercise-list">
                            ${hypertrophyExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'accessory', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // STRENGTH ENDURANCE Section
            if (strengthEnduranceExercises.length > 0) {
                html += `
                    <div class="exercise-section">
                        <h4 class="section-header">Strength Endurance</h4>
                        <ul class="exercise-list">
                            ${strengthEnduranceExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'accessory', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // CONDITIONING/MOBILITY Section (Most Metabolic, Lowest Neural)
            const recoveryExercises = [...conditioningExercises, ...mobilityExercises];
            if (recoveryExercises.length > 0) {
                html += `
                    <div class="exercise-section">
                        <h4 class="section-header">Conditioning/Recovery</h4>
                        <ul class="exercise-list">
                            ${recoveryExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'accessory', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            return html;
        }

        function renderMediumDaySections(exercises, day) {
            // Medium days: Group into Recovery + Upper Lift
            const recoveryExercises = exercises.filter(ex => 
                ex.component === 'conditioning' || ex.component === 'mobility'
            );
            const strengthExercises = exercises.filter(ex => 
                ex.component === 'relative strength' || ex.component === 'hypertrophy'
            );
            
            let html = `
                <div class="exercise-section">
                    <h4 class="section-header">Recovery Base</h4>
                    <ul class="exercise-list">
                        ${recoveryExercises.map((exercise, index) => 
                            renderExerciseItem(exercise, 'accessory', day, index)
                        ).join('')}
                    </ul>
                </div>
            `;
            
            if (strengthExercises.length > 0) {
                html += `
                    <div class="exercise-section lifting-section">
                        <h4 class="section-header">Upper Body Maintenance</h4>
                        <ul class="exercise-list">
                            ${strengthExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'lifting', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            return html;
        }

        function renderLowDaySections(exercises, day) {
            // Low days: Simple recovery focus
            return `
                <div class="exercise-section">
                    <h4 class="section-header">Recovery & Mobility</h4>
                    <ul class="exercise-list">
                        ${exercises.map((exercise, index) => 
                            renderExerciseItem(exercise, 'accessory', day, index)
                        ).join('')}
                    </ul>
                </div>
            `;
        }

        function displayWeeklyPlan(plan) {
            const container = document.getElementById('weeklyPlanContainer');
            container.innerHTML = '';

            Object.entries(plan).forEach(([day, dayPlan]) => {
                if (dayPlan.type === 'rest') {
                    // Rest day card
                    const restCard = document.createElement('div');
                    restCard.className = 'day-card';
                    restCard.style.opacity = '0.6';
                    restCard.innerHTML = `
                        <div class="day-header">
                            <div class="day-title">${day}</div>
                            <div style="color: var(--text-secondary);">REST</div>
                        </div>
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Complete rest and recovery
                        </div>
                    `;
                    container.appendChild(restCard);
                    return;
                }

                const dayCard = document.createElement('div');
                // Handle medium day styling
                const dayClass = dayPlan.type === 'medium' ? 'medium-day' : `${dayPlan.type}-day`;
                dayCard.className = `day-card ${dayClass}`;
                
                // Create the day header with proper medium day display
                const dayTypeDisplay = dayPlan.type === 'medium' ? 'MEDIUM DAY' : `${dayPlan.type.toUpperCase()} DAY`;
                const intensityClass = dayPlan.type === 'medium' ? 'medium-intensity' : `${dayPlan.type}-intensity`;
                
                const dayHeader = `
                    <div class="day-header">
                        <div class="day-title">${day}</div>
                        <div>
                            <span class="intensity-indicator ${intensityClass}"></span>
                            ${dayTypeDisplay}
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                        ${dayPlan.focus} • ${dayPlan.duration} min
                    </div>
                `;
                
                let exerciseHTML = '';
                
                // For HIGH days: Full vertical integration sequencing
                if (dayPlan.type === 'high') {
                    exerciseHTML = renderVerticalIntegrationSections(dayPlan.exercises, day);
                }
                // For MEDIUM days: Simplified sections
                else if (dayPlan.type === 'medium') {
                    exerciseHTML = renderMediumDaySections(dayPlan.exercises, day);
                }
                // For LOW days: Simple recovery layout
                else if (dayPlan.type === 'low') {
                    exerciseHTML = renderLowDaySections(dayPlan.exercises, day);
                }
                
                dayCard.innerHTML = dayHeader + exerciseHTML;
                container.appendChild(dayCard);
            });
        }

        function renderExerciseItem(exercise, section, day, index) {
            const sets = exercise.sets || 'N/A';
            const reps = exercise.reps || 'N/A';
            const quickInfo = `${sets}×${reps}`;
            
            return `
                <li class="exercise-item ${section}-exercise expandable" onclick="toggleExerciseDetail(this, event)">
                    <div class="exercise-summary">
                        <span class="exercise-name">${exercise.name}</span>
                        <span class="exercise-quick-info">${quickInfo}</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="exercise-details">
                        <div class="parameter-grid">
                            <div class="param">
                                <strong>Sets</strong>
                                <div class="value">${sets}</div>
                            </div>
                            <div class="param">
                                <strong>Reps</strong>
                                <div class="value">${reps}</div>
                            </div>
                            <div class="param">
                                <strong>Rest</strong>
                                <div class="value">${exercise.rest || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>Load</strong>
                                <div class="value">${exercise.load || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>CNS Score</strong>
                                <div class="value">${exercise.cns}/10</div>
                            </div>
                            <div class="param">
                                <strong>Classification</strong>
                                <div class="value">${exercise.classification || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>Adaptation</strong>
                                <div class="value">${exercise.adaptation || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>Component</strong>
                                <div class="value">${exercise.component || 'N/A'}</div>
                            </div>
                            ${exercise.notes ? `
                            <div class="param full-width">
                                <strong>Coaching Notes</strong>
                                <div class="value">${exercise.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="exercise-actions">
                            <button class="btn btn-secondary btn-small" onclick="swapExercise('${day}', ${index}); event.stopPropagation();">Swap</button>
                            <button class="btn btn-secondary btn-small" onclick="removeExercise('${day}', ${index}); event.stopPropagation();">Remove</button>
                        </div>
                    </div>
                </li>
            `;
        }

        function updateStats(plan) {
            let totalVolume = 0;
            let highDays = 0;
            let lowDays = 0;

            Object.values(plan).forEach(day => {
                if (day.type === 'rest') return;
                
                totalVolume += day.exercises.length;
                
                if (day.type === 'high') {
                    highDays++;
                } else if (day.type === 'low') {
                    lowDays++;
                }
            });

            document.getElementById('weeklyVolume').textContent = totalVolume;
            document.getElementById('highIntensityDays').textContent = highDays;
            document.getElementById('lowIntensityDays').textContent = lowDays;
        }

        function updateProgress() {
            const progressBar = document.getElementById('weeklyProgress');
            const progress = Math.min(currentDay * 16.67, 100);
            progressBar.style.width = progress + '%';
        }

        // ==================== MODIFICATION FUNCTIONS ====================
        
        function processModification() {
            const input = document.getElementById('chatInput');
            const command = input.value.toLowerCase().trim();
            
            if (!command) return;

            addChatMessage("You", input.value);
            input.value = '';

            // Process common modifications
            if (command.includes('bodyweight')) {
                makeBodyweightOnly();
            } else if (command.includes('power') && command.includes('increase')) {
                increasePowerFocus();
            } else if (command.includes('cns') && command.includes('reduce')) {
                reduceCNSLoad();
            } else if (command.includes('volume') && command.includes('reduce')) {
                reduceVolume(20);
            } else if (command.includes('more variety') || command.includes('different exercises')) {
                regenerateWithVariety();
            } else {
                addChatMessage("Assistant", "Available modifications: 'make bodyweight only', 'increase power focus', 'reduce CNS load', 'reduce volume', 'more variety'");
            }
        }

        function makeBodyweightOnly() {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'rest') return;
                
                dayPlan.exercises = dayPlan.exercises.map(exercise => {
                    const bodyweightSub = findBodyweightSubstitution(exercise);
                    return {
                        ...exercise,
                        ...bodyweightSub
                    };
                });
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            addChatMessage("Assistant", "Converted to bodyweight-only while preserving ME/DE/SE/RE classifications and vertical integration sequencing.");
        }

        function findBodyweightSubstitution(exercise) {
            const classification = exercise.classification || '';
            const exerciseName = exercise.name.toLowerCase();
            
            // Max Effort substitutions with doorway isometrics
            if (classification.includes('Max Effort')) {
                if (exerciseName.includes('squat')) {
                    return { 
                        name: 'Doorway Single-Leg Squat Hold',
                        load: '100% max effort isometric',
                        notes: '90° knee angle against doorframe, maximum force production each leg'
                    };
                }
                if (exerciseName.includes('press') || exerciseName.includes('bench')) {
                    return { 
                        name: 'Doorway Chest Push (Isometric)',
                        load: '100% max effort against immovable object',
                        notes: 'Chest-height against doorframe, maximum force production'
                    };
                }
                if (exerciseName.includes('deadlift')) {
                    return { 
                        name: 'Doorway Deadlift Pull (Isometric)',
                        load: '100% max effort isometric',
                        notes: 'Hip-height pull against immovable doorframe'
                    };
                }
            }
            
            // Dynamic Effort substitutions
            if (classification.includes('Dynamic Effort')) {
                if (exerciseName.includes('clean') || exerciseName.includes('power')) {
                    return { 
                        name: 'Explosive Jump Squats',
                        load: '100% max intent',
                        notes: 'Maximum explosive effort, full reset between reps'
                    };
                }
                if (exerciseName.includes('slam') || exerciseName.includes('throw')) {
                    return { 
                        name: 'Explosive Push-ups',
                        load: '100% max intent',
                        notes: 'Hands leave ground, maximum explosive effort'
                    };
                }
            }
            
            // Default bodyweight alternatives
            return {
                name: 'Bodyweight ' + exercise.name,
                load: 'Bodyweight',
                notes: 'Bodyweight alternative maintaining training stimulus'
            };
        }

        function increasePowerFocus() {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'high') {
                    // Add more dynamic effort exercises
                    const powerExercise = {
                        name: 'Added Jump Squats',
                        classification: 'Dynamic Effort',
                        adaptation: 'Power',
                        component: 'power',
                        cns: 7,
                        sets: 4, reps: 5,
                        load: '100% max intent',
                        rest: '2min',
                        notes: 'Explosive up, soft landing'
                    };
                    dayPlan.exercises.unshift(powerExercise);
                    dayPlan.focus = dayPlan.focus.replace(/Strength|Mixed/, 'Power');
                }
            });
            
            displayWeeklyPlan(currentPlan);
            addChatMessage("Assistant", "Increased power focus by adding Dynamic Effort exercises with maximum explosive intent while maintaining vertical integration.");
        }

        function reduceCNSLoad() {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'high') {
                    // Remove highest CNS exercises or reduce intensity
                    dayPlan.exercises = dayPlan.exercises.filter(ex => ex.cns <= 8);
                    dayPlan.exercises.forEach(ex => {
                        if (ex.load && ex.load.includes('85%')) {
                            ex.load = ex.load.replace('85%', '80%');
                        }
                        if (ex.load && ex.load.includes('90%')) {
                            ex.load = ex.load.replace('90%', '85%');
                        }
                        // Reduce CNS score
                        ex.cns = Math.max(1, ex.cns - 1);
                    });
                }
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            addChatMessage("Assistant", "Reduced CNS load by removing highest demand exercises and reducing intensities while maintaining vertical integration structure.");
        }

        function reduceVolume(percentage) {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'rest') return;
                
                dayPlan.exercises.forEach(exercise => {
                    if (exercise.sets && typeof exercise.sets === 'number') {
                        exercise.sets = Math.max(1, Math.floor(exercise.sets * (1 - percentage / 100)));
                    }
                });
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            addChatMessage("Assistant", `Reduced training volume by ${percentage}% while maintaining ME/DE/SE/RE structure and vertical integration sequencing.`);
        }
        
        function regenerateWithVariety() {
            if (!currentPlan) return;
            
            // Force regeneration with different exercise selection
            const button = document.querySelector('.btn[onclick="generatePlan()"]');
            button.textContent = 'Adding Variety...';
            
            // Clear cached exercises to get fresh selection
            ExerciseDBManager.cached_exercises = null;
            
            generatePlan();
            addChatMessage("Assistant", "Regenerated program with fresh exercise selection for maximum variety while preserving vertical integration principles!");
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function toggleExerciseDetail(element, event) {
            if (event) event.stopPropagation();
            element.classList.toggle('expanded');
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            
            const button = document.querySelector('.theme-toggle');
            button.innerHTML = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        function toggleCollapsible(element) {
            const collapsible = element.parentElement;
            const isActive = collapsible.classList.contains('active');
            
            // Close all other collapsibles
            document.querySelectorAll('.collapsible.active').forEach(el => {
                el.classList.remove('active');
                el.querySelector('.collapsible-header span').textContent = '+';
            });
            
            if (!isActive) {
                collapsible.classList.add('active');
                element.querySelector('span').textContent = '-';
            }
        }

        function toggleTechnical(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('show');
            }
        }

        function swapExercise(day, exerciseIndex) {
            const newExercise = prompt('Enter replacement exercise:');
            if (newExercise && currentPlan[day]) {
                currentPlan[day].exercises[exerciseIndex].name = newExercise;
                displayWeeklyPlan(currentPlan);
                addChatMessage("Assistant", `Swapped exercise in ${day} session.`);
            }
        }

        function removeExercise(day, exerciseIndex) {
            if (currentPlan[day]) {
                const removed = currentPlan[day].exercises.splice(exerciseIndex, 1)[0];
                displayWeeklyPlan(currentPlan);
                updateStats(currentPlan);
                addChatMessage("Assistant", `Removed "${removed.name}" from ${day} session.`);
            }
        }

        function addChatMessage(sender, message) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '10px';
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ==================== INITIALIZATION ====================
        
        async function initializeApp() {
            console.log('Enhanced Three Anchor System with ExerciseDB Integration Starting...');
            
            // Start loading exercises in background
            ExerciseDBManager.loadExercises().then(exercises => {
                const source = exercises.some(ex => ex.source === 'exercisedb') ? 'ExerciseDB + Original' : 'Original System';
                console.log(`Exercise database ready: ${exercises.length} exercises from ${source}`);
            });
            
            // Generate initial plan automatically
            setTimeout(async () => {
                await generatePlan();
                
                const exercises = await ExerciseDBManager.loadExercises();
                const source = exercises.some(ex => ex.source === 'exercisedb') ? 'ExerciseDB + Three Anchor Intelligence' : 'Original Three Anchor System';
                
                addChatMessage("Assistant", `Welcome to the Enhanced Three Anchor Training System! 
                    Now powered by ${source} with ${exercises.length} exercises. 
                    This system uses proper Vertical Integration sequencing: Speed → Power → Strength → Hypertrophy → Endurance, 
                    combined with High-Low CNS management and ME/DE/SE/RE classifications. 
                    Try modifying parameters or use chat commands!`);
            }, 500);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        console.log('Enhanced Three Anchor Training System with ExerciseDB Integration Loaded Successfully');
        console.log('Exercise Database: Original system enhanced with ExerciseDB integration');
        console.log('Max Effort: 85-100% loads with your specific classifications');
        console.log('Dynamic Effort: Explosive movements with maximum intent focus');
        console.log('Submaximal Effort: 75-85% loads for functional hypertrophy');
        console.log('Repetition Effort: Higher volume work for strength endurance');
        console.log('Vertical Integration: Speed → Power → Strength → Hypertrophy → Endurance sequencing');
        console.log('High-Low System: CNS-aware weekly patterns with intelligent recovery');
        console.log('LLM-Ready: Enhanced exercise database prepared for AI-powered program generation');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Training Assistant - Enhanced 3 Anchor High-Low ME/DE/SE/RE System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: color 0.2s ease, background-color 0.2s ease;
        }

        :root {
            /* Brand Colors from Ignition APG */
            --primary-color: #ff6b35;
            --secondary-color: #f7931e;
            --accent-color: #4ecdc4;
            
            /* Semantic Colors */
            --success-color: #4ecdc4;
            --warning-color: #f7931e;
            --error-color: #e74c3c;
            
            /* Background Colors - Cleaner whites/grays */
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            
            /* Text Colors - Better contrast */
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            
            /* Border Colors */
            --border-color: #e5e5e5;
            --border-light: #f0f0f0;
            
            /* Intensity Indicators */
            --high-intensity: #ff6b35;
            --medium-intensity: #f7931e;
            --low-intensity: #4ecdc4;
            
            /* Shadows - Subtle depth */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --border-color: #404040;
            --border-light: #2a2a2a;
            
            /* Shadows for dark mode */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.6);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-group {
            margin-bottom: 25px;
        }

        .field-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .field-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .dropdown {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown:hover {
            border-color: #d0d0d0;
        }

        .dropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
            background: var(--bg-primary);
        }

        .toggle-technical {
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }

        .toggle-technical:hover {
            color: #e55a2b;
        }

        .technical-details {
            display: none;
            margin-top: 8px;
        }

        .technical-details.show {
            display: block;
        }

        .technical-note {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-left: 3px solid var(--primary-color);
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            border-radius: 0 6px 6px 0;
            line-height: 1.4;
        }

        .technical-note strong {
            color: var(--text-primary);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.01em;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.25);
        }

        .btn:hover {
            background: #e55a2b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.35);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(255, 107, 53, 0.25);
        }

        .btn-secondary {
            background: var(--text-secondary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .intensity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .high-intensity {
            background: var(--high-intensity);
        }

        .medium-intensity {
            background: var(--medium-intensity);
        }

        .low-intensity {
            background: var(--low-intensity);
        }

        .weekly-plan {
            grid-column: 1 / -1;
        }

        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            border: 1.5px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .high-day {
            border-left: 4px solid var(--high-intensity);
            background: linear-gradient(to right, rgba(255, 107, 53, 0.03) 0%, var(--bg-primary) 100%);
        }

        .medium-day {
            border-left: 4px solid var(--medium-intensity);
            background: linear-gradient(to right, rgba(247, 147, 30, 0.03) 0%, var(--bg-primary) 100%);
        }

        .low-day {
            border-left: 4px solid var(--low-intensity);
            background: linear-gradient(to right, rgba(78, 205, 196, 0.03) 0%, var(--bg-primary) 100%);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .day-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .exercise-section {
            margin-bottom: 20px;
        }

        .section-header {
            margin: 0 0 16px 0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .field-section .section-header {
            color: var(--accent-color);
        }

        .lifting-section .section-header {
            color: var(--primary-color);
        }

        .exercise-list {
            list-style: none;
        }

        .exercise-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            transition: all 0.15s ease;
            border: 1px solid var(--border-light);
        }

        .exercise-item.expandable {
            cursor: pointer;
        }

        .exercise-item.expandable:hover {
            background: var(--bg-tertiary);
            box-shadow: var(--shadow-sm);
        }

        .exercise-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
        }

        .exercise-name {
            flex: 1;
            font-weight: 500;
        }

        .exercise-quick-info {
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 10px;
        }

        .expand-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .exercise-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .exercise-details {
            padding: 0 15px 15px 15px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .exercise-item.expanded .exercise-details {
            display: block;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .param {
            font-size: 14px;
        }

        .param strong {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .param .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .param.full-width {
            grid-column: 1 / -1;
        }

        .field-exercise {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid var(--accent-color);
        }

        .lifting-exercise {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid var(--primary-color);
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }

        .modification-panel {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .chat-interface {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
            background: var(--bg-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.03em;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .collapsible {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .collapsible-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .collapsible-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible.active .collapsible-content {
            max-height: 200px;
            padding: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        /* Loading state animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .generating {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .plan-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Three Anchor - Dynamic Classification System</h1>
            <button class="theme-toggle" onclick="toggleTheme()">Dark Mode</button>
        </div>

        <div class="dashboard-grid">
            <!-- Input Panel -->
            <div class="card">
                <h2>Training Configuration</h2>

                <div class="field-group">
                    <label class="field-label" for="trainingAge">Step 1: What's your training experience?</label>
                    <p class="field-description">Determines exercise complexity and CNS loading capacity</p>
                    <select class="dropdown" id="trainingAge">
                        <option value="beginner">Beginner/Novice (Introductory)</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced/Elite</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('age-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="age-tech">
                        <strong>Dynamic Classification:</strong> Same exercises automatically adjust from Max Effort (beginners) → Submaximal Effort (intermediate) → Repetition Effort (advanced) based on your capacity.
                    </div>
                </div>
                
                <div class="field-group">
                    <label class="field-label" for="trainingGoal">Step 2: What's your main goal right now?</label>
                    <p class="field-description">Determines ME/DE/SE/RE method emphasis and volume distribution</p>
                    <select class="dropdown" id="trainingGoal">
                        <option value="hypertrophy">Build Muscle (Repetition Effort Focus)</option>
                        <option value="strength" selected>Get Stronger (Max Effort Focus)</option>
                        <option value="power">Improve Power & Speed (Dynamic Effort Focus)</option>
                        <option value="balanced">Balanced Development (Mixed Methods)</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('goal-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="goal-tech">
                        <strong>Contextual Methods:</strong> Max Effort (85-100% 1RM), Dynamic Effort (explosive intent), Submaximal Effort (75-85%), Repetition Effort (60-75% to failure). Classifications adapt to your capacity.
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="splitType">Step 3: How many days can you train per week?</label>
                    <p class="field-description">High-Low pattern optimizes CNS recovery and adaptation</p>
                    <select class="dropdown" id="splitType">
                        <option value="3-day-high-low" selected>3 Days - High-Low Pattern (H-L-H-L-H-L-L)</option>
                        <option value="4-day-high-low">4 Days - High-Low Pattern (H-M-L-H-L-L-L)</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('split-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="split-tech">
                        <strong>High Days:</strong> SAQ + Heavy lifting (8-10 CNS). <strong>Medium Days:</strong> Recovery + single lift. <strong>Low Days:</strong> Recovery + accessories (3-5 CNS).
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="duration">Step 4: How long are your typical workouts?</label>
                    <p class="field-description">Affects exercise selection and volume distribution</p>
                    <select class="dropdown" id="duration">
                        <option value="45">45 minutes</option>
                        <option value="60" selected>60 minutes (Recommended)</option>
                        <option value="75">75 minutes</option>
                        <option value="90">90+ minutes</option>
                    </select>
                </div>

                <div class="field-group">
                    <label class="field-label" for="trainingBlock">Step 5: What training phase are you in?</label>
                    <p class="field-description">Block periodization determines intensity and volume emphasis</p>
                    <select class="dropdown" id="trainingBlock">
                        <option value="accumulation" selected>Accumulation - Building Strength Base</option>
                        <option value="transmutation">Transmutation - Converting to Power</option>
                        <option value="realization">Realization - Competition Prep</option>
                        <option value="transition-gpp">Transition/GPP - Recovery Phase</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('phase-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="phase-tech">
                        <strong>Phase Intelligence:</strong> Accumulation (higher volume), Transmutation (explosive focus), Realization (peak intensity), GPP (movement quality). Exercises auto-adapt to phase goals.
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="blockLength">Step 6: How long should this phase last?</label>
                    <p class="field-description">Adaptation time without staleness</p>
                    <select class="dropdown" id="blockLength">
                        <option value="2">2 weeks (Short Adaptation)</option>
                        <option value="3">3 weeks (Moderate Adaptation)</option>
                        <option value="4" selected>4 weeks (Recommended)</option>
                    </select>
                </div>

                <div class="field-group">
                    <label class="field-label" for="equipment">Step 7: What equipment do you have access to?</label>
                    <p class="field-description">Determines exercise selection and ME/DE/SE/RE implementations</p>
                    <select class="dropdown" id="equipment">
                        <option value="full-gym" selected>Full Gym Access (Barbell + Equipment)</option>
                        <option value="basic">Basic Equipment (Dumbbells, Bands, Bench)</option>
                        <option value="bodyweight">Bodyweight Only (Doorway Isometrics)</option>
                    </select>
                    <span class="toggle-technical" onclick="toggleTechnical('equipment-tech')">Show technical details</span>
                    <div class="technical-details technical-note" id="equipment-tech">
                        <strong>Smart Adaptation:</strong> System automatically adapts exercise complexity and classification based on available equipment while preserving training stimulus.
                    </div>
                </div>

                <button class="btn" onclick="generatePlan()">Generate Smart Program</button>
            </div>

            <!-- Plan Overview Panel -->
            <div class="card">
                <h2>Plan Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyVolume">16</div>
                        <div class="stat-label">Weekly Exercises</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="highIntensityDays">3</div>
                        <div class="stat-label">High CNS Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lowIntensityDays">2</div>
                        <div class="stat-label">Low CNS Days</div>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        Dynamic Exercise Classification
                        <span>+</span>
                    </div>
                    <div class="collapsible-content">
                        <p>Exercises automatically adapt their classification, intensity, and volume based on your training age, current phase, and individual capacity. The same movement can be Max Effort for beginners or Repetition Effort for advanced athletes.</p>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        Vertical Integration Sequencing
                        <span>+</span>
                    </div>
                    <div class="collapsible-content">
                        <p>Speed → Power → Strength → Hypertrophy → Endurance. This sequence optimizes neural readiness while managing fatigue accumulation throughout each training session.</p>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        High-Low Training Principles
                        <span>+</span>
                    </div>
                    <div class="collapsible-content">
                        <p>The High-Low training model alternates between high CNS-demanding days (8-10 CNS) and low recovery days (3-5 CNS). This optimizes adaptation while preventing overtraining and ensuring proper recovery.</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label>Weekly Progress</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyProgress" style="width: 25%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Plan Display -->
        <div class="card weekly-plan">
            <h2>Enhanced Weekly Training Plan</h2>
            
            <div class="plan-grid" id="weeklyPlanContainer">
                <!-- Plan will be generated here -->
            </div>

            <!-- Modification Panel -->
            <div class="modification-panel">
                <h3>Intelligent Program Modifications</h3>
                <div class="chat-interface">
                    <div id="chatHistory" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
                    <div class="chat-input">
                        <input type="text" class="form-control" id="chatInput" placeholder="e.g., 'make bodyweight only', 'increase power focus', 'more variety', 'reduce CNS load'">
                        <button class="btn" onclick="processModification()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DYNAMIC CLASSIFICATION ENGINE ====================
        
        const DynamicClassifier = {
            // Core method to reclassify exercises based on user context
            reclassifyExercise(exercise, userInputs) {
                const context = {
                    trainingAge: userInputs.trainingAge,
                    block: userInputs.block,
                    equipment: userInputs.equipment,
                    goal: userInputs.goal
                };
                
                // Calculate user capacity based on training age
                const userCapacity = this.getUserCapacity(context.trainingAge);
                
                // Get exercise complexity score
                const exerciseComplexity = this.getExerciseComplexity(exercise);
                
                // Determine contextual classification
                const newClassification = this.determineClassification(exercise, exerciseComplexity, userCapacity, context);
                
                return {
                    ...exercise,
                    classification: newClassification.classification,
                    adaptation: newClassification.adaptation,
                    component: newClassification.component,
                    cns: newClassification.cns,
                    sets: newClassification.sets,
                    reps: newClassification.reps,
                    load: newClassification.load,
                    rest: newClassification.rest,
                    context_note: `Adapted for ${context.trainingAge} in ${context.block} phase`,
                    original_classification: exercise.classification // Keep track of original
                };
            },
            
            // Determine user capacity based on training age
            getUserCapacity(trainingAge) {
                const capacityMap = {
                    'beginner': 3,     // Low capacity - many exercises will be challenging
                    'intermediate': 6,  // Moderate capacity - balanced programming
                    'advanced': 9      // High capacity - need intensity to challenge
                };
                return capacityMap[trainingAge] || 6;
            },
            
            // Calculate exercise complexity (1-10 scale)
            getExerciseComplexity(exercise) {
                let complexity = 5; // Base complexity
                const name = exercise.name.toLowerCase();
                
                // Compound movements are more complex
                if (name.includes('deadlift')) complexity = 10;
                if (name.includes('squat') && name.includes('pistol')) complexity = 9;
                if (name.includes('clean') || name.includes('snatch')) complexity = 10;
                if (name.includes('squat') && !name.includes('pistol')) complexity = 8;
                if (name.includes('bench press') || name.includes('press')) complexity = 7;
                if (name.includes('row') || name.includes('pulldown')) complexity = 6;
                if (name.includes('lunge') || name.includes('step')) complexity = 6;
                
                // Unilateral movements add complexity
                if (name.includes('single') || name.includes('one arm') || name.includes('pistol')) complexity += 1;
                
                // Explosive movements add complexity
                if (name.includes('jump') || name.includes('explosive') || name.includes('slam')) complexity += 1;
                
                // Isometric holds are complex for beginners but easier for advanced
                if (name.includes('hold') || name.includes('isometric')) complexity += 1;
                
                // Isolation movements are simpler
                if (name.includes('curl') || name.includes('extension') || name.includes('fly')) complexity = Math.max(2, complexity - 2);
                if (name.includes('calf') || name.includes('wrist')) complexity = Math.max(1, complexity - 3);
                
                // Bodyweight basics
                if (name.includes('push-up') && !name.includes('explosive')) complexity = 4;
                if (name.includes('mobility') || name.includes('flow')) complexity = 2;
                
                return Math.max(1, Math.min(10, complexity));
            },
            
            // Main classification logic
            determineClassification(exercise, exerciseComplexity, userCapacity, context) {
                // Calculate relative difficulty for this user
                const relativeDifficulty = exerciseComplexity / userCapacity;
                
                // Block phase modifications
                let phaseModifier = this.getPhaseModifier(context.block, context.goal);
                
                // Apply phase modifier to relative difficulty
                const adjustedDifficulty = relativeDifficulty * phaseModifier.intensityMultiplier;
                
                // Base classification on adjusted difficulty
                let classification = this.classifyByDifficulty(adjustedDifficulty);
                
                // Phase-specific overrides
                classification = this.applyPhaseOverrides(classification, phaseModifier, exercise);
                
                // Calculate contextual parameters
                return this.generateContextualParameters(classification, exercise, context, adjustedDifficulty);
            },
            
            // Phase-specific modifiers
            getPhaseModifier(block, goal) {
                const phaseMap = {
                    'accumulation': {
                        intensityMultiplier: 0.9,
                        volumeEmphasis: true,
                        preferredMethods: ['Submaximal Effort', 'Repetition Effort']
                    },
                    'transmutation': {
                        intensityMultiplier: 1.1,
                        powerEmphasis: true,
                        preferredMethods: ['Dynamic Effort', 'Max Effort']
                    },
                    'realization': {
                        intensityMultiplier: 1.2,
                        peakingMode: true,
                        preferredMethods: ['Max Effort', 'Dynamic Effort']
                    },
                    'transition-gpp': {
                        intensityMultiplier: 0.8,
                        recoveryMode: true,
                        preferredMethods: ['Repetition Effort', 'Submaximal Effort']
                    }
                };
                
                return phaseMap[block] || phaseMap['accumulation'];
            },
            
            // Classify based on relative difficulty
            classifyByDifficulty(difficulty) {
                if (difficulty >= 0.9) {
                    return 'Max Effort';
                } else if (difficulty >= 0.75) {
                    return 'Submaximal Effort';
                } else if (difficulty >= 0.6) {
                    return 'Repetition Effort';
                } else {
                    return 'Repetition Effort'; // Very easy exercises default to RE
                }
            },
            
            // Apply phase-specific overrides
            applyPhaseOverrides(classification, phaseModifier, exercise) {
                // Transmutation phase: convert suitable exercises to Dynamic Effort
                if (phaseModifier.powerEmphasis) {
                    if (this.canBeExplosive(exercise)) {
                        return 'Dynamic Effort';
                    }
                }
                
                // Accumulation phase: prefer higher volume methods
                if (phaseModifier.volumeEmphasis && classification === 'Max Effort') {
                    return 'Submaximal Effort';
                }
                
                // Realization phase: intensify suitable exercises
                if (phaseModifier.peakingMode && classification === 'Repetition Effort') {
                    if (this.canBePeaked(exercise)) {
                        return 'Submaximal Effort';
                    }
                }
                
                return classification;
            },
            
            // Check if exercise can be performed explosively
            canBeExplosive(exercise) {
                const name = exercise.name.toLowerCase();
                const explosiveCapable = [
                    'squat', 'jump', 'press', 'push-up', 'row', 'pull'
                ];
                return explosiveCapable.some(keyword => name.includes(keyword)) && 
                       !name.includes('curl') && !name.includes('extension');
            },
            
            // Check if exercise can be peaked for competition
            canBePeaked(exercise) {
                const name = exercise.name.toLowerCase();
                const peakable = [
                    'squat', 'bench', 'press', 'deadlift', 'clean', 'snatch'
                ];
                return peakable.some(keyword => name.includes(keyword));
            },
            
            // Generate contextual training parameters
            generateContextualParameters(classification, exercise, context, difficulty) {
                const baseParams = this.getBaseParameters(classification);
                
                // Training age adjustments
                const ageAdjustments = this.getTrainingAgeAdjustments(context.trainingAge, difficulty);
                
                // Calculate CNS based on classification and context
                const contextualCNS = this.calculateContextualCNS(exercise, classification, context, difficulty);
                
                return {
                    classification: classification,
                    adaptation: this.getAdaptation(classification),
                    component: this.getComponent(classification),
                    cns: contextualCNS,
                    sets: Math.max(1, Math.round(baseParams.sets * ageAdjustments.volumeMultiplier)),
                    reps: this.adjustReps(baseParams.reps, ageAdjustments),
                    load: this.generateLoad(classification, context, difficulty),
                    rest: baseParams.rest
                };
            },
            
            // Base parameters for each classification
            getBaseParameters(classification) {
                const paramMap = {
                    'Max Effort': { sets: 3, reps: 5, rest: '3-4min' },
                    'Dynamic Effort': { sets: 4, reps: 5, rest: '2-3min' },
                    'Submaximal Effort': { sets: 3, reps: 8, rest: '2-3min' },
                    'Repetition Effort': { sets: 2, reps: '15-20', rest: '60-90s' }
                };
                return paramMap[classification] || paramMap['Repetition Effort'];
            },
            
            // Training age specific adjustments
            getTrainingAgeAdjustments(trainingAge, difficulty) {
                const adjustmentMap = {
                    'beginner': {
                        volumeMultiplier: difficulty > 0.8 ? 0.7 : 1.0,
                        repReduction: difficulty > 0.8 ? 0.7 : 1.0
                    },
                    'intermediate': {
                        volumeMultiplier: 1.0,
                        repReduction: 1.0
                    },
                    'advanced': {
                        volumeMultiplier: difficulty < 0.6 ? 1.3 : 1.0,
                        repReduction: 1.0
                    }
                };
                return adjustmentMap[trainingAge] || adjustmentMap['intermediate'];
            },
            
            // Calculate contextual CNS score
            calculateContextualCNS(exercise, classification, context, difficulty) {
                let baseCNS = {
                    'Max Effort': 8,
                    'Dynamic Effort': 7,
                    'Submaximal Effort': 5,
                    'Repetition Effort': 3
                }[classification] || 4;
                
                // Adjust for exercise complexity
                const name = exercise.name.toLowerCase();
                if (name.includes('deadlift') || name.includes('clean')) baseCNS += 2;
                if (name.includes('squat') && !name.includes('curl')) baseCNS += 1;
                if (name.includes('sprint') || name.includes('jump')) baseCNS += 1;
                
                // Training age adjustments
                if (context.trainingAge === 'beginner' && difficulty > 0.8) {
                    baseCNS = Math.min(baseCNS + 1, 10); // Beginners find difficult exercises more taxing
                }
                if (context.trainingAge === 'advanced' && difficulty < 0.6) {
                    baseCNS = Math.max(baseCNS - 1, 1); // Advanced find easy exercises less taxing
                }
                
                return Math.max(1, Math.min(10, baseCNS));
            },
            
            // Get adaptation type
            getAdaptation(classification) {
                const adaptationMap = {
                    'Max Effort': 'Relative Strength',
                    'Dynamic Effort': 'Power',
                    'Submaximal Effort': 'Functional Hypertrophy',
                    'Repetition Effort': 'Strength Endurance'
                };
                return adaptationMap[classification] || 'Strength Endurance';
            },
            
            // Get component type
            getComponent(classification) {
                const componentMap = {
                    'Max Effort': 'relative strength',
                    'Dynamic Effort': 'power',
                    'Submaximal Effort': 'functional hypertrophy',
                    'Repetition Effort': 'strength endurance'
                };
                return componentMap[classification] || 'strength endurance';
            },
            
            // Adjust reps based on context
            adjustReps(baseReps, ageAdjustments) {
                if (typeof baseReps === 'string') return baseReps;
                return Math.max(1, Math.round(baseReps * ageAdjustments.repReduction));
            },
            
            // Generate contextual load prescription
            generateLoad(classification, context, difficulty) {
                const baseLoads = {
                    'Max Effort': difficulty > 0.9 ? '90-95% 1RM / RPE 9-10' : '85-90% 1RM / RPE 9',
                    'Dynamic Effort': 'Bodyweight / 100% intent',
                    'Submaximal Effort': '75-85% 1RM / RPE 7-8',
                    'Repetition Effort': '60-75% effort / RPE 6-7'
                };
                
                let load = baseLoads[classification] || '70% effort';
                
                // Training age modifications
                if (context.trainingAge === 'beginner') {
                    load = load.replace('85-90%', '75-85%').replace('RPE 9-10', 'RPE 8-9');
                }
                
                return load;
            },
            
            // Batch process all exercises for a user context
            reclassifyExerciseDatabase(exercises, userInputs) {
                return exercises.map(exercise => this.reclassifyExercise(exercise, userInputs));
            }
        };

        // ==================== EXERCISEDB INTEGRATION LAYER ====================
        
        const ExerciseDBManager = {
            cached_exercises: null,
            loading: false,
            
            async loadExercises() {
                if (this.cached_exercises) return this.cached_exercises;
                if (this.loading) return this.getOriginalExercises();
                
                this.loading = true;
                console.log('Loading exercises from ExerciseDB...');
                
                try {
                    // Using ExerciseDB API with fallback
                    const response = await fetch('https://exercisedb-api-lemon.vercel.app/api/v1/exercises');
                    
                    if (!response.ok) throw new Error('ExerciseDB API failed');
                    
                    const exerciseDBData = await response.json();
                    console.log(`Loaded ${exerciseDBData.length} exercises from ExerciseDB`);
                    
                    // Enhance with Three Anchor classifications
                    const enhancedExercises = this.enhanceWithThreeAnchor(exerciseDBData.slice(0, 100)); // Limit for performance
                    
                    // Combine with original system
                    this.cached_exercises = [...this.getOriginalExercises(), ...enhancedExercises];
                    console.log(`Total exercise database: ${this.cached_exercises.length} exercises`);
                    return this.cached_exercises;
                    
                } catch (error) {
                    console.warn('ExerciseDB failed, using original system:', error);
                    this.cached_exercises = this.getOriginalExercises();
                    return this.cached_exercises;
                } finally {
                    this.loading = false;
                }
            },
            
            enhanceWithThreeAnchor(exerciseDBData) {
                return exerciseDBData.map(exercise => {
                    const enhanced = ThreeAnchorClassifier.classify(exercise);
                    return {
                        ...enhanced,
                        source: 'exercisedb',
                        original_data: exercise
                    };
                }).filter(ex => ex.classification); // Only include successfully classified exercises
            },
            
            getOriginalExercises() {
                // Convert original exercise database to array format
                return Object.values(ME_DE_SE_RE_EXERCISES).map(ex => ({
                    ...ex,
                    source: 'original',
                    exerciseId: ex.name.toLowerCase().replace(/\s+/g, '_')
                }));
            },
            
            filterByEquipment(exercises, equipment) {
                if (equipment === 'full-gym') return exercises;
                if (equipment === 'bodyweight') {
                    return exercises.filter(ex => 
                        ex.source === 'original' || // Keep all original exercises
                        !ex.equipment || 
                        ex.equipment.includes('bodyweight') ||
                        ex.equipment.includes('none') ||
                        ex.classification?.includes('Isometric')
                    );
                }
                if (equipment === 'basic') {
                    return exercises.filter(ex => 
                        ex.source === 'original' || // Keep all original exercises
                        !ex.equipment || 
                        ex.equipment.includes('dumbbell') ||
                        ex.equipment.includes('bodyweight') ||
                        ex.equipment.includes('resistance band')
                    );
                }
                return exercises;
            }
        };
        
        const ThreeAnchorClassifier = {
            classify(exerciseDBExercise) {
                const name = exerciseDBExercise.name || '';
                const category = exerciseDBExercise.category || '';
                const equipment = exerciseDBExercise.equipments || exerciseDBExercise.equipment || [];
                const bodyParts = exerciseDBExercise.bodyParts || [];
                const targetMuscles = exerciseDBExercise.targetMuscles || [];
                
                // Determine component and classification based on exercise characteristics
                const analysis = this.analyzeExercise(name, category, equipment, bodyParts);
                
                return {
                    exerciseId: exerciseDBExercise.exerciseId || name.toLowerCase().replace(/\s+/g, '_'),
                    name: name,
                    classification: analysis.classification,
                    adaptation: analysis.adaptation,
                    component: analysis.component,
                    cns: analysis.cns,
                    sets: analysis.sets,
                    reps: analysis.reps,
                    load: analysis.load,
                    rest: analysis.rest,
                    notes: this.generateNotes(exerciseDBExercise),
                    equipment: Array.isArray(equipment) ? equipment : [equipment],
                    bodyParts: bodyParts,
                    targetMuscles: targetMuscles
                };
            },
            
            analyzeExercise(name, category, equipment, bodyParts) {
                const nameLower = name.toLowerCase();
                
                // Max Effort Classification (85-100% loads)
                if (this.isMaxEffort(nameLower, category)) {
                    return {
                        classification: "Max Effort",
                        adaptation: "Relative Strength",
                        component: "relative strength",
                        cns: this.calculateCNS(nameLower, 'max_effort'),
                        sets: 3, reps: 5,
                        load: "85% 1RM / RPE 9",
                        rest: "3-4min"
                    };
                }
                
                // Dynamic Effort Classification (Explosive/Power)
                if (this.isDynamicEffort(nameLower, category)) {
                    return {
                        classification: "Dynamic Effort",
                        adaptation: "Power",
                        component: "power",
                        cns: this.calculateCNS(nameLower, 'dynamic_effort'),
                        sets: 4, reps: 5,
                        load: "Bodyweight / 100% intent",
                        rest: "2-3min"
                    };
                }
                
                // Submaximal Effort Classification (75-85%)
                if (this.isSubmaximalEffort(nameLower, category)) {
                    return {
                        classification: "Submaximal Effort",
                        adaptation: "Functional Hypertrophy",
                        component: "functional hypertrophy",
                        cns: this.calculateCNS(nameLower, 'submaximal_effort'),
                        sets: 3, reps: 6,
                        load: "80% 1RM / RPE 8",
                        rest: "2-3min"
                    };
                }
                
                // Repetition Effort Classification (60-75% to failure)
                return {
                    classification: "Repetition Effort",
                    adaptation: "Strength Endurance",
                    component: "strength endurance",
                    cns: this.calculateCNS(nameLower, 'repetition_effort'),
                    sets: 2, reps: "15-20",
                    load: "70% effort / RPE 7-8",
                    rest: "30-60s"
                };
            },
            
            isMaxEffort(name, category) {
                const maxEffortKeywords = [
                    'deadlift', 'squat', 'bench press', 'overhead press',
                    'clean', 'snatch', 'jerk', '1rm', 'max'
                ];
                return maxEffortKeywords.some(keyword => name.includes(keyword));
            },
            
            isDynamicEffort(name, category) {
                const dynamicKeywords = [
                    'jump', 'explosive', 'power', 'sprint', 'throw',
                    'slam', 'clap', 'speed', 'plyo', 'bounce'
                ];
                return dynamicKeywords.some(keyword => name.includes(keyword));
            },
            
            isSubmaximalEffort(name, category) {
                const submaximalKeywords = [
                    'tempo', 'pause', 'pin press', 'box squat',
                    'front squat', 'incline', 'decline', 'lunge', 'row'
                ];
                return submaximalKeywords.some(keyword => name.includes(keyword));
            },
            
            calculateCNS(name, classification) {
                let baseCNS = {
                    'max_effort': 8,
                    'dynamic_effort': 7,
                    'submaximal_effort': 6,
                    'repetition_effort': 3
                }[classification] || 4;
                
                // Adjust based on exercise characteristics
                if (name.includes('deadlift')) baseCNS += 2;
                if (name.includes('squat')) baseCNS += 1;
                if (name.includes('sprint')) baseCNS += 2;
                if (name.includes('isolation') || name.includes('curl')) baseCNS -= 2;
                
                return Math.max(1, Math.min(10, baseCNS));
            },
            
            generateNotes(exercise) {
                const instructions = exercise.instructions || [];
                if (instructions.length > 0) {
                    return instructions[0]; // Use first instruction as note
                }
                return "Focus on proper form and controlled movement";
            }
        };

        // ==================== ORIGINAL ME/DE/SE/RE EXERCISE DATABASE ====================
        
        const ME_DE_SE_RE_EXERCISES = {
            // MAX EFFORT EXERCISES (85-100% 1RM)
            back_squat: {
                name: "Back Squat",
                classification: "Max Effort",
                adaptation: "Relative Strength",
                component: "relative strength",
                cns: 9,
                sets: 3, reps: 5,
                load: "85% 1RM / RPE 9",
                rest: "3-4min",
                notes: "Full depth, drive through heels, controlled eccentric"
            },
            bench_press: {
                name: "Bench Press", 
                classification: "Max Effort",
                adaptation: "Relative Strength",
                component: "relative strength",
                cns: 6,
                sets: 3, reps: 4,
                load: "85% 1RM / RPE 9",
                rest: "3-4min",
                notes: "Pause on chest, drive with legs, controlled eccentric"
            },
            deadlift: {
                name: "Deadlift",
                classification: "Max Effort", 
                adaptation: "Relative Strength",
                component: "relative strength",
                cns: 10,
                sets: 3, reps: 3,
                load: "90% 1RM / RPE 9-10",
                rest: "4-5min",
                notes: "Hip hinge, neutral spine, drive through heels"
            },
            
            // DYNAMIC EFFORT EXERCISES (Explosive Intent)
            power_clean: {
                name: "Power Clean",
                classification: "Dynamic Effort",
                adaptation: "Power", 
                component: "power",
                cns: 10,
                sets: 5, reps: 2,
                load: "75% 1RM / 100% intent",
                rest: "3min",
                notes: "Maximum bar speed, catch in quarter squat"
            },
            jump_squat: {
                name: "Jump Squats",
                classification: "Dynamic Effort",
                adaptation: "Power",
                component: "power", 
                cns: 7,
                sets: 4, reps: 5,
                load: "Bodyweight / 100% intent",
                rest: "2min",
                notes: "Explosive up, soft landing, full reset between reps"
            },
            med_ball_slam: {
                name: "Medicine Ball Slam",
                classification: "Dynamic Effort",
                adaptation: "Power",
                component: "power",
                cns: 6,
                sets: 4, reps: 6,
                load: "10kg ball / 90% max effort",
                rest: "90s",
                notes: "Overhead to floor, pick up and reset each rep"
            },
            
            // SUBMAXIMAL EFFORT EXERCISES (75-85% 1RM)
            rfe_squat: {
                name: "RFE Squat",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 6,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Upright torso, full ROM"
            },
            barbell_incline: {
                name: "Barbell Incline Press",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 6,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Control descent, pause between reps"
            },
            walking_lunge: {
                name: "Walking Lunge",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 6,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Upright torso, big lunge forward"
            },
            romanian_deadlift: {
                name: "Romanian Deadlift (RDL)",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 7,
                sets: 3, reps: 8,
                load: "80% 1RM / RPE 8",
                rest: "2-3min",
                notes: "Clean grip, upright torso, drive elbows up"
            },
            overhead_press: {
                name: "Overhead Press",
                classification: "Submaximal Effort",
                adaptation: "Functional Hypertrophy",
                component: "functional hypertrophy",
                cns: 5,
                sets: 3, reps: 8,
                load: "75% 1RM / RPE 7-8", 
                rest: "1-2min",
                notes: "Controlled eccentric, full ROM"
            },
            db_row: {
                name: "Single-Arm DB Row",
                classification: "Submaximal Effort",
                adaptation: "Hypertrophy",
                component: "hypertrophy",
                cns: 3,
                sets: 3, reps: "12",
                load: "70% effort / RPE 7-8",
                rest: "90s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            barbell_row: {
                name: "BB Row",
                classification: "Submaximal Effort",
                adaptation: "Hypertrophy",
                component: "hypertrophy",
                cns: 3,
                sets: 3, reps: "12",
                load: "70% effort / RPE 7-8",
                rest: "90s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            supported_row: {
                name: "Chest Supported Row",
                classification: "Submaximal Effort",
                adaptation: "Hypertrophy",
                component: "hypertrophy",
                cns: 3,
                sets: 3, reps: "12",
                load: "70% effort / RPE 7-8",
                rest: "90s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            // REPETITION EFFORT EXERCISES (60-75% to failure)
            bicep_curl: {
                name: "Bicep Curl",
                classification: "Repetition Effort",
                adaptation: "Strength Endurance",
                component: "strength endurance",
                cns: 3,
                sets: 2, reps: "15-20",
                load: "70% effort / RPE 7-8",
                rest: "30-60s",
                notes: "Squeeze at top, control eccentric, full ROM"
            },
            tricep_extension: {
                name: "Tricep Extension",
                classification: "Repetition Effort", 
                adaptation: "Strength Endurance",
                component: "strength endurance",
                cns: 4,
                sets: 2, reps: "15-20",
                load: "RPE 7-8",
                rest: "30-60s",
                notes: "Squeeze at bottom, keep elbows tight"
            },
            shoulder_fly: {
                name: "DB Shoulder Fly",
                classification: "Repetition Effort", 
                adaptation: "Strength Endurance",
                component: "strength endurance",
                cns: 4,
                sets: 2, reps: "15-20",
                load: "RPE 7-8",
                rest: "30-60s",
                notes: "Squeeze at bottom, keep elbows tight"
            },
            // BODYWEIGHT MAX EFFORT ALTERNATIVES
            doorway_squat_hold: {
                name: "Doorway Single-Leg Squat Hold",
                classification: "Max Effort",
                adaptation: "Unilateral Strength",
                component: "relative strength",
                cns: 7,
                sets: 4, reps: "10-sec holds each leg",
                load: "100% max effort isometric",
                rest: "2min",
                notes: "90° knee angle against doorframe, maximum force production"
            },
            doorway_chest_push: {
                name: "Doorway Chest Push (Isometric)", 
                classification: "Max Effort",
                adaptation: "Upper Body Strength",
                component: "relative strength",
                cns: 6,
                sets: 4, reps: "8-sec holds",
                load: "100% max effort against immovable object",
                rest: "2min",
                notes: "Chest-height against doorframe, maximum force production"
            },
            
            // SPEED/SAQ COMPONENTS
            sprint_20m: {
                name: "20m Sprints",
                classification: "Alactic Power",
                adaptation: "Neural Power",
                component: "speed",
                cns: 10,
                sets: 5, reps: 3,
                load: "95-100% max velocity",
                rest: "3-4min",
                notes: "Maximum velocity, full recovery between reps"
            },
            agility_ladder: {
                name: "Agility Ladder (Multi-directional)",
                classification: "Alactic Power", 
                adaptation: "Neural Coordination",
                component: "speed",
                cns: 8,
                sets: 6, reps: "15sec",
                load: "100% max effort",
                rest: "2min", 
                notes: "Change direction patterns each set"
            },
            
            // RECOVERY/CONDITIONING COMPONENTS
            tempo_run: {
                name: "Tempo Runs",
                classification: "Submaximal Effort",
                adaptation: "Aerobic Base",
                component: "conditioning",
                cns: 3,
                sets: 1, reps: "15min",
                load: "70-75% effort / HR Zone 2",
                rest: "N/A",
                notes: "Nasal breathing, conversational pace"
            },
            mobility_flow: {
                name: "Dynamic Mobility Flow",
                classification: "Repetition Effort",
                adaptation: "Movement Quality",
                component: "mobility", 
                cns: 1,
                sets: 2, reps: "10 each direction",
                load: "Bodyweight / RPE 3-4",
                rest: "minimal",
                notes: "Full ROM, controlled movements, focus on quality"
            }
        };

        // ==================== ORIGINAL PROGRAM TEMPLATES WITH PROPER VERTICAL INTEGRATION ====================
        
        const PROGRAM_TEMPLATES = {
            // 3-Day High-Low Pattern (H-L-H-L-H-L-L)
            strength_focus_3day: {
                title: "3-Day Vertical Integration - Strength Focus",
                monday: {
                    type: "high",
                    focus: "Full Vertical Integration - Workout A",
                    exercises: [
                        // SPEED (Highest Neural, Highest Risk)
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m},
                        // POWER (Explosive Effort)
                        {...ME_DE_SE_RE_EXERCISES.jump_squat},
                        // RELATIVE STRENGTH (Max Effort Primary)
                        {...ME_DE_SE_RE_EXERCISES.back_squat},
                        // FUNCTIONAL HYPERTROPHY (Submaximal Effort Secondary)
                        {...ME_DE_SE_RE_EXERCISES.barbell_incline},
                        // HYPERTROPHY (Submaximal Effort Auxiliary)
                        {...ME_DE_SE_RE_EXERCISES.supported_row},
                        // STRENGTH ENDURANCE (Repetition Effort Isolation, Lowest Neural, Most Metabolic)
                        {...ME_DE_SE_RE_EXERCISES.bicep_curl}
                    ]
                },
                tuesday: {
                    type: "low", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                        // Low days: Tempo/Recovery focus only
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                wednesday: {
                    type: "high",
                    focus: "Full Vertical Integration - Workout B", 
                    exercises: [
                        // SPEED
                        {...ME_DE_SE_RE_EXERCISES.agility_ladder},
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.power_clean},
                        // RELATIVE STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.bench_press},
                        // FUNCTIONAL HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.rfe_squat},
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.db_row},
                        // STRENGTH ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.tricep_extension}
                    ]
                },
                thursday: {
                    type: "low", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                        // Low days: Tempo/Recovery focus only
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                friday: {
                    type: "high",
                    focus: "Full Vertical Integration - Workout C", 
                    exercises: [
                        // SPEED
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m},
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.power_clean},
                        // RELATIVE STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.deadlift},
                        // FUNCTIONAL HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.overhead_press},
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.barbell_row},
                        // STRENGTH ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.shoulder_fly}
                    ]
                },
                saturday: {
                    type: "low", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                        // Low days: Tempo/Recovery focus only
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                sunday: {
                    type: "off", 
                    focus: "Recovery + Low CNS Maintenance",
                    exercises: [
                    ]
                }
            },

            // 4-Day High-Low Pattern (H-M-L-H-L-L-L) - Upper/Lower Split
            strength_focus_4day: {
                title: "4-Day Upper/Lower - Vertical Integration",
                monday: {
                    type: "high",
                    focus: "Lower Body - Full Vertical Integration",
                    exercises: [
                        // SPEED
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m},
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.jump_squat},
                        // STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.back_squat},
                        {...ME_DE_SE_RE_EXERCISES.deadlift, sets: 2, reps: 2}, // Reduced volume
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.walking_lunge},
                        // ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                tuesday: {
                    type: "medium",
                    focus: "Upper Body - Recovery Base + Upper Lift",
                    exercises: [
                        // Medium day = Low day foundation + upper body strength work
                        {...ME_DE_SE_RE_EXERCISES.tempo_run, reps: "10min"}, // Shorter tempo
                        {...ME_DE_SE_RE_EXERCISES.bench_press, sets: 3, load: "80% 1RM / RPE 7"}, // Single upper lift
                        {...ME_DE_SE_RE_EXERCISES.db_row, sets: 3},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                },
                wednesday: {
                    type: "low",
                    focus: "Complete Recovery",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow, sets: 3}
                    ]
                },
                thursday: {
                    type: "high",
                    focus: "Upper Body - Full Vertical Integration",
                    exercises: [
                        // SPEED (Upper body speed work)
                        {...ME_DE_SE_RE_EXERCISES.agility_ladder, sets: 4, cns: 6}, // Reduced for upper focus
                        // POWER
                        {...ME_DE_SE_RE_EXERCISES.med_ball_slam},
                        {...ME_DE_SE_RE_EXERCISES.power_clean}, 
                        // STRENGTH
                        {...ME_DE_SE_RE_EXERCISES.bench_press},
                        {...ME_DE_SE_RE_EXERCISES.barbell_incline},
                        // HYPERTROPHY
                        {...ME_DE_SE_RE_EXERCISES.db_row},
                        // ENDURANCE
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                }
            },

            power_focus: {
                title: "Dynamic Effort Power Focus",
                monday: {
                    type: "high",
                    focus: "Speed + Dynamic Effort",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.sprint_20m, sets: 6},
                        {...ME_DE_SE_RE_EXERCISES.power_clean, sets: 6},
                        {...ME_DE_SE_RE_EXERCISES.jump_squat, sets: 5},
                        {...ME_DE_SE_RE_EXERCISES.med_ball_slam, sets: 5},
                        {...ME_DE_SE_RE_EXERCISES.back_squat, sets: 3, load: "75% 1RM / RPE 7"}
                    ]
                },
                tuesday: {
                    type: "low",
                    focus: "Recovery + Strength Maintenance",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.tempo_run, reps: "12min"},
                        {...ME_DE_SE_RE_EXERCISES.rfe_squat, sets: 3, load: "70% 1RM / RPE 6"},
                        {...ME_DE_SE_RE_EXERCISES.barbell_incline, sets: 3, load: "70% 1RM / RPE 6"},
                        {...ME_DE_SE_RE_EXERCISES.db_row, sets: 3}
                    ]
                },
                thursday: {
                    type: "high",
                    focus: "Power + Agility",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.agility_ladder, sets: 8},
                        {...ME_DE_SE_RE_EXERCISES.jump_squat, sets: 6, reps: 3},
                        {...ME_DE_SE_RE_EXERCISES.med_ball_slam, sets: 6},
                        {...ME_DE_SE_RE_EXERCISES.deadlift, sets: 3, load: "80% 1RM / RPE 8"},
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                }
            },
            
            bodyweight_only: {
                title: "Bodyweight High-Low with Isometric Max Effort",
                monday: {
                    type: "high",
                    focus: "Max Effort Isometrics + Power",
                    exercises: [
                        {
                            name: "Hill Sprints",
                            classification: "Alactic Power",
                            adaptation: "Neural Power", 
                            component: "speed",
                            cns: 9,
                            sets: 5, reps: "20yd",
                            load: "100% max effort uphill",
                            rest: "3min",
                            notes: "Focus on drive phase, walk down recovery"
                        },
                        {...ME_DE_SE_RE_EXERCISES.jump_squat},
                        {...ME_DE_SE_RE_EXERCISES.doorway_squat_hold},
                        {...ME_DE_SE_RE_EXERCISES.doorway_chest_push},
                        {
                            name: "Single-leg Glute Bridge Hold",
                            classification: "Max Effort",
                            adaptation: "Posterior Chain Strength",
                            component: "relative strength",
                            cns: 6,
                            sets: 3, reps: "15-sec holds each leg", 
                            load: "100% max effort",
                            rest: "2min",
                            notes: "Maximum glute contraction, hold at top"
                        }
                    ]
                },
                tuesday: {
                    type: "low",
                    focus: "Repetition Effort + Recovery",
                    exercises: [
                        {...ME_DE_SE_RE_EXERCISES.tempo_run},
                        {
                            name: "Push-ups (High Volume)",
                            classification: "Repetition Effort",
                            adaptation: "Upper Body Hypertrophy",
                            component: "hypertrophy",
                            cns: 3,
                            sets: 4, reps: "15-25",
                            load: "RPE 7-8",
                            rest: "90s",
                            notes: "Modify angle as needed, focus on time under tension"
                        },
                        {...ME_DE_SE_RE_EXERCISES.walking_lunge, sets: 4, reps: "15 each leg", name: "Bodyweight Lunges"},
                        {
                            name: "Pike Push-ups",
                            classification: "Repetition Effort", 
                            adaptation: "Shoulder Hypertrophy",
                            component: "hypertrophy",
                            cns: 4,
                            sets: 3, reps: "8-12",
                            load: "RPE 7-8",
                            rest: "90s",
                            notes: "Feet elevated if possible, focus on shoulders"
                        }
                    ]
                },
                thursday: {
                    type: "high",
                    focus: "Dynamic Effort + Unilateral Strength",
                    exercises: [
                        {
                            name: "Broad Jumps",
                            classification: "Dynamic Effort",
                            adaptation: "Horizontal Power",
                            component: "power",
                            cns: 7,
                            sets: 5, reps: 3,
                            load: "100% max intent",
                            rest: "2min",
                            notes: "Maximum distance, full reset between reps"
                        },
                        {
                            name: "Explosive Push-ups",
                            classification: "Dynamic Effort",
                            adaptation: "Upper Body Power",
                            component: "power", 
                            cns: 6,
                            sets: 4, reps: 5,
                            load: "100% max intent",
                            rest: "90s",
                            notes: "Hands leave ground, maximum explosive effort"
                        },
                        {
                            name: "Single-leg Squat (Assisted)",
                            classification: "Max Effort",
                            adaptation: "Unilateral Strength",
                            component: "relative strength",
                            cns: 7,
                            sets: 4, reps: "5 each leg",
                            load: "85-90% max effort",
                            rest: "2min",
                            notes: "Use assistance as needed, focus on full ROM"
                        },
                        {...ME_DE_SE_RE_EXERCISES.mobility_flow}
                    ]
                }
            }
        };

        // ==================== GLOBAL VARIABLES ====================
        
        let currentPlan = null;
        let currentDay = 0;

        // ==================== ENHANCED CORE FUNCTIONS ====================
        
        async function generatePlan() {
            console.log('Generate plan called with Dynamic Classification System');
            
            // Show loading state
            document.querySelector('.btn[onclick="generatePlan()"]').classList.add('generating');
            document.querySelector('.btn[onclick="generatePlan()"]').textContent = 'Generating Program...';
            
            try {
                // Get form values
                const goal = document.getElementById('trainingGoal')?.value || 'strength';
                const split = document.getElementById('splitType')?.value || '3-day-high-low';
                const equipment = document.getElementById('equipment')?.value || 'full-gym';
                const duration = document.getElementById('duration')?.value || '60';
                const block = document.getElementById('trainingBlock')?.value || 'accumulation';
                const blockLength = document.getElementById('blockLength')?.value || '4';
                const trainingAge = document.getElementById('trainingAge')?.value || 'intermediate';

                console.log('Form values:', { goal, split, equipment, duration, block, blockLength, trainingAge });

                // Load enhanced exercise database
                const availableExercises = await ExerciseDBManager.loadExercises();
                const filteredExercises = ExerciseDBManager.filterByEquipment(availableExercises, equipment);
                
                console.log(`Working with ${filteredExercises.length} exercises for ${equipment} equipment`);

                // Select appropriate program template based on split type
                let selectedTemplate;
                if (equipment === 'bodyweight') {
                    selectedTemplate = PROGRAM_TEMPLATES.bodyweight_only;
                } else if (split === '4-day-high-low') {
                    selectedTemplate = PROGRAM_TEMPLATES.strength_focus_4day;
                } else if (goal === 'power') {
                    selectedTemplate = PROGRAM_TEMPLATES.power_focus;
                } else {
                    selectedTemplate = PROGRAM_TEMPLATES.strength_focus_3day;
                }
                
                // Generate weekly plan with enhanced exercise pool
                currentPlan = await generateEnhancedProgram(selectedTemplate, { 
                    goal, split, equipment, duration, block, blockLength, trainingAge 
                }, filteredExercises);
                
                console.log('Generated enhanced plan:', currentPlan);
                
                displayWeeklyPlan(currentPlan);
                updateStats(currentPlan);
                updateProgress();

                const exerciseCount = filteredExercises.length;
                const source = filteredExercises.some(ex => ex.source === 'exercisedb') ? 'Enhanced with ExerciseDB' : 'Original System';
                
                addChatMessage("Assistant", `Generated ${selectedTemplate.title} with Dynamic Classification System. Exercises automatically adapted for ${trainingAge} in ${block} phase using ${source} (${exerciseCount} exercises available).`);
                    
            } catch (error) {
                console.error('Program generation failed:', error);
                addChatMessage("Assistant", "Program generation encountered an issue. Using original system to ensure you get a working program.");
                
                // Fallback to original system
                generateOriginalPlan();
            } finally {
                // Reset button state
                const button = document.querySelector('.btn[onclick="generatePlan()"]');
                button.classList.remove('generating');
                button.textContent = 'Generate Smart Program';
            }
        }
        
        async function generateEnhancedProgram(template, userInputs, availableExercises) {
            // STEP 1: Apply dynamic classification to all available exercises
            console.log('Applying dynamic classification based on user context...');
            const reclassifiedExercises = DynamicClassifier.reclassifyExerciseDatabase(availableExercises, userInputs);
            
            console.log(`Reclassified ${reclassifiedExercises.length} exercises for ${userInputs.trainingAge} in ${userInputs.block} phase`);
            
            // STEP 2: Start with the original template structure using reclassified exercises
            const plan = adaptTemplateWithReclassifiedExercises(template, userInputs, reclassifiedExercises);
            
            // STEP 3: Enhance with additional exercises from the reclassified pool where appropriate
            Object.keys(plan).forEach(day => {
                if (plan[day].type === 'high' && plan[day].exercises.length > 0) {
                    // Potentially add one additional exercise from the reclassified pool
                    const additionalExercise = selectAdditionalExerciseFromReclassified(reclassifiedExercises, plan[day].exercises, userInputs);
                    if (additionalExercise) {
                        plan[day].exercises.push(additionalExercise);
                        console.log(`Added contextual exercise: ${additionalExercise.name} (${additionalExercise.classification})`);
                    }
                }
            });
            
            return plan;
        }
        
        function adaptTemplateWithReclassifiedExercises(template, userInputs, reclassifiedExercises) {
            const plan = {};
            
            // Add Saturday and Sunday as rest days for 3-day plan
            const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            allDays.forEach(day => {
                const dayKey = day.toLowerCase();
                
                if (template[dayKey]) {
                    // Use template day
                    plan[day] = {
                        ...template[dayKey],
                        duration: userInputs.duration,
                        block: userInputs.block,
                        blockLength: userInputs.blockLength,
                        title: template.title
                    };
                    
                    // Apply dynamic classification to template exercises
                    plan[day].exercises = plan[day].exercises.map(exercise => {
                        // Find a better match in reclassified exercises, or apply dynamic classification to current
                        const reclassified = DynamicClassifier.reclassifyExercise(exercise, userInputs);
                        return reclassified;
                    });
                } else {
                    // Rest day
                    plan[day] = {
                        type: "rest",
                        focus: "Complete Rest",
                        exercises: [],
                        duration: 0,
                        title: "Rest Day"
                    };
                }
            });
            
            return plan;
        }
        
        function selectAdditionalExerciseFromReclassified(reclassifiedExercises, currentExercises, userInputs) {
            // Select an exercise from the reclassified pool that complements the current session
            const availableAdditional = reclassifiedExercises.filter(ex => ex.source === 'exercisedb');
            if (availableAdditional.length === 0) return null;
            
            // Calculate current CNS load
            const currentCNS = currentExercises.reduce((sum, ex) => sum + (ex.cns || 0), 0);
            const maxCNS = userInputs.trainingAge === 'beginner' ? 25 : userInputs.trainingAge === 'advanced' ? 45 : 35;
            
            // Look for a low-CNS exercise that won't overload the session
            const suitableExercises = availableAdditional.filter(ex => {
                const wouldExceedCNS = (currentCNS + ex.cns) > maxCNS;
                const alreadyIncluded = currentExercises.some(current => current.name === ex.name);
                return !wouldExceedCNS && !alreadyIncluded && ex.cns <= 4;
            });
            
            if (suitableExercises.length === 0) return null;
            
            // Prefer exercises that match the session's primary adaptation focus
            const primaryAdaptations = currentExercises.map(ex => ex.adaptation);
            const matchingAdaptation = suitableExercises.filter(ex => 
                primaryAdaptations.includes(ex.adaptation)
            );
            
            const finalPool = matchingAdaptation.length > 0 ? matchingAdaptation : suitableExercises;
            
            // Return a random suitable exercise
            return finalPool[Math.floor(Math.random() * finalPool.length)];
        }
        
        function selectAdditionalExercise(availableExercises, currentExercises, userInputs) {
            // Select an exercise from ExerciseDB that complements the current session
            const exerciseDBExercises = availableExercises.filter(ex => ex.source === 'exercisedb');
            if (exerciseDBExercises.length === 0) return null;
            
            // Calculate current CNS load
            const currentCNS = currentExercises.reduce((sum, ex) => sum + (ex.cns || 0), 0);
            const maxCNS = userInputs.trainingAge === 'beginner' ? 25 : userInputs.trainingAge === 'advanced' ? 45 : 35;
            
            // Look for a low-CNS exercise that won't overload the session
            const suitableExercises = exerciseDBExercises.filter(ex => 
                ex.cns <= 4 && (currentCNS + ex.cns) <= maxCNS
            );
            
            if (suitableExercises.length === 0) return null;
            
            // Return a random suitable exercise
            return suitableExercises[Math.floor(Math.random() * suitableExercises.length)];
        }
        
        function generateOriginalPlan() {
            // Original system as backup
            const goal = document.getElementById('trainingGoal')?.value || 'strength';
            const split = document.getElementById('splitType')?.value || '3-day-high-low';
            const equipment = document.getElementById('equipment')?.value || 'full-gym';
            
            let selectedTemplate;
            if (equipment === 'bodyweight') {
                selectedTemplate = PROGRAM_TEMPLATES.bodyweight_only;
            } else if (split === '4-day-high-low') {
                selectedTemplate = PROGRAM_TEMPLATES.strength_focus_4day;
            } else if (goal === 'power') {
                selectedTemplate = PROGRAM_TEMPLATES.power_focus;
            } else {
                selectedTemplate = PROGRAM_TEMPLATES.strength_focus_3day;
            }
            
            currentPlan = adaptTemplate(selectedTemplate, { 
                goal, equipment, 
                duration: '60', 
                block: 'accumulation', 
                trainingAge: 'intermediate' 
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            updateProgress();
        }

        function adaptTemplate(template, userInputs) {
            const plan = {};
            
            // Add Saturday and Sunday as rest days for 3-day plan
            const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            allDays.forEach(day => {
                const dayKey = day.toLowerCase();
                
                if (template[dayKey]) {
                    // Use template day
                    plan[day] = {
                        ...template[dayKey],
                        duration: userInputs.duration,
                        block: userInputs.block,
                        blockLength: userInputs.blockLength,
                        title: template.title
                    };
                    
                    // Apply user-specific adaptations
                    plan[day].exercises = plan[day].exercises.map(exercise => 
                        adaptExercise(exercise, userInputs)
                    );
                } else {
                    // Rest day
                    plan[day] = {
                        type: "rest",
                        focus: "Complete Rest",
                        exercises: [],
                        duration: 0,
                        title: "Rest Day"
                    };
                }
            });
            
            return plan;
        }

        function adaptExercise(exercise, userInputs) {
            let adapted = { ...exercise };
            
            // Training age adaptations
            if (userInputs.trainingAge === 'beginner') {
                // Reduce intensity for beginners
                if (adapted.load && adapted.load.includes('85%')) {
                    adapted.load = adapted.load.replace('85%', '75%');
                }
                if (adapted.load && adapted.load.includes('90%')) {
                    adapted.load = adapted.load.replace('90%', '80%');
                }
                // Reduce CNS for safety
                adapted.cns = Math.min(adapted.cns, 7);
            }
            
            // Phase adaptations
            if (userInputs.block === 'gpp') {
                // Increase volume, reduce intensity for GPP
                if (typeof adapted.sets === 'number') {
                    adapted.sets = Math.min(adapted.sets + 1, 6);
                }
                adapted.cns = Math.max(1, adapted.cns - 1);
            } else if (userInputs.block === 'realization') {
                // Reduce volume, increase intensity for peaking
                if (typeof adapted.sets === 'number') {
                    adapted.sets = Math.max(adapted.sets - 1, 1);
                }
                if (adapted.classification === 'Max Effort') {
                    adapted.load = adapted.load.replace('85%', '90-95%');
                }
            }
            
            return adapted;
        }

        // ==================== VERTICAL INTEGRATION RENDERING FUNCTIONS ====================

        function renderVerticalIntegrationSections(exercises, day) {
            // Group exercises by vertical integration sequence
            const speedExercises = exercises.filter(ex => ex.component === 'speed');
            const powerExercises = exercises.filter(ex => ex.component === 'power');
            const relativeStrengthExercises = exercises.filter(ex => ex.component === 'relative strength');
            const functionalHypertrophyExercises = exercises.filter(ex => ex.component === 'functional hypertrophy');
            const hypertrophyExercises = exercises.filter(ex => ex.component === 'hypertrophy');
            const strengthEnduranceExercises = exercises.filter(ex => ex.component === 'strength endurance');
            const conditioningExercises = exercises.filter(ex => ex.component === 'conditioning');
            const mobilityExercises = exercises.filter(ex => ex.component === 'mobility');
            
            let html = '';
            
            // SPEED Section (Highest Neural/Risk)
            if (speedExercises.length > 0) {
                html += `
                    <div class="exercise-section field-section">
                        <h4 class="section-header">Speed/SAQ (Neural Prime)</h4>
                        <ul class="exercise-list">
                            ${speedExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'field', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // POWER Section
            if (powerExercises.length > 0) {
                html += `
                    <div class="exercise-section field-section">
                        <h4 class="section-header">Power/Explosive</h4>
                        <ul class="exercise-list">
                            ${powerExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'field', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // RELATIVE STRENGTH Section
            if (relativeStrengthExercises.length > 0) {
                html += `
                    <div class="exercise-section lifting-section">
                        <h4 class="section-header">Relative Strength Work</h4>
                        <ul class="exercise-list">
                            ${relativeStrengthExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'lifting', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // FUNCTIONAL HYPERTROPHY Section
            if (functionalHypertrophyExercises.length > 0) {
                html += `
                    <div class="exercise-section lifting-section">
                        <h4 class="section-header">Functional Hypertrophy</h4>
                        <ul class="exercise-list">
                            ${functionalHypertrophyExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'lifting', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // HYPERTROPHY Section
            if (hypertrophyExercises.length > 0) {
                html += `
                    <div class="exercise-section">
                        <h4 class="section-header">Hypertrophy</h4>
                        <ul class="exercise-list">
                            ${hypertrophyExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'accessory', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // STRENGTH ENDURANCE Section
            if (strengthEnduranceExercises.length > 0) {
                html += `
                    <div class="exercise-section">
                        <h4 class="section-header">Strength Endurance</h4>
                        <ul class="exercise-list">
                            ${strengthEnduranceExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'accessory', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // CONDITIONING/MOBILITY Section (Most Metabolic, Lowest Neural)
            const recoveryExercises = [...conditioningExercises, ...mobilityExercises];
            if (recoveryExercises.length > 0) {
                html += `
                    <div class="exercise-section">
                        <h4 class="section-header">Conditioning/Recovery</h4>
                        <ul class="exercise-list">
                            ${recoveryExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'accessory', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            return html;
        }

        function renderMediumDaySections(exercises, day) {
            // Medium days: Group into Recovery + Upper Lift
            const recoveryExercises = exercises.filter(ex => 
                ex.component === 'conditioning' || ex.component === 'mobility'
            );
            const strengthExercises = exercises.filter(ex => 
                ex.component === 'relative strength' || ex.component === 'hypertrophy'
            );
            
            let html = `
                <div class="exercise-section">
                    <h4 class="section-header">Recovery Base</h4>
                    <ul class="exercise-list">
                        ${recoveryExercises.map((exercise, index) => 
                            renderExerciseItem(exercise, 'accessory', day, index)
                        ).join('')}
                    </ul>
                </div>
            `;
            
            if (strengthExercises.length > 0) {
                html += `
                    <div class="exercise-section lifting-section">
                        <h4 class="section-header">Upper Body Maintenance</h4>
                        <ul class="exercise-list">
                            ${strengthExercises.map((exercise, index) => 
                                renderExerciseItem(exercise, 'lifting', day, index)
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            return html;
        }

        function renderLowDaySections(exercises, day) {
            // Low days: Simple recovery focus
            return `
                <div class="exercise-section">
                    <h4 class="section-header">Recovery & Mobility</h4>
                    <ul class="exercise-list">
                        ${exercises.map((exercise, index) => 
                            renderExerciseItem(exercise, 'accessory', day, index)
                        ).join('')}
                    </ul>
                </div>
            `;
        }

        function displayWeeklyPlan(plan) {
            const container = document.getElementById('weeklyPlanContainer');
            container.innerHTML = '';

            Object.entries(plan).forEach(([day, dayPlan]) => {
                if (dayPlan.type === 'rest') {
                    // Rest day card
                    const restCard = document.createElement('div');
                    restCard.className = 'day-card';
                    restCard.style.opacity = '0.6';
                    restCard.innerHTML = `
                        <div class="day-header">
                            <div class="day-title">${day}</div>
                            <div style="color: var(--text-secondary);">REST</div>
                        </div>
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Complete rest and recovery
                        </div>
                    `;
                    container.appendChild(restCard);
                    return;
                }

                const dayCard = document.createElement('div');
                // Handle medium day styling
                const dayClass = dayPlan.type === 'medium' ? 'medium-day' : `${dayPlan.type}-day`;
                dayCard.className = `day-card ${dayClass}`;
                
                // Create the day header with proper medium day display
                const dayTypeDisplay = dayPlan.type === 'medium' ? 'MEDIUM DAY' : `${dayPlan.type.toUpperCase()} DAY`;
                const intensityClass = dayPlan.type === 'medium' ? 'medium-intensity' : `${dayPlan.type}-intensity`;
                
                const dayHeader = `
                    <div class="day-header">
                        <div class="day-title">${day}</div>
                        <div>
                            <span class="intensity-indicator ${intensityClass}"></span>
                            ${dayTypeDisplay}
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                        ${dayPlan.focus} • ${dayPlan.duration} min
                    </div>
                `;
                
                let exerciseHTML = '';
                
                // For HIGH days: Full vertical integration sequencing
                if (dayPlan.type === 'high') {
                    exerciseHTML = renderVerticalIntegrationSections(dayPlan.exercises, day);
                }
                // For MEDIUM days: Simplified sections
                else if (dayPlan.type === 'medium') {
                    exerciseHTML = renderMediumDaySections(dayPlan.exercises, day);
                }
                // For LOW days: Simple recovery layout
                else if (dayPlan.type === 'low') {
                    exerciseHTML = renderLowDaySections(dayPlan.exercises, day);
                }
                
                dayCard.innerHTML = dayHeader + exerciseHTML;
                container.appendChild(dayCard);
            });
        }

        function renderExerciseItem(exercise, section, day, index) {
            const sets = exercise.sets || 'N/A';
            const reps = exercise.reps || 'N/A';
            const quickInfo = `${sets}×${reps}`;
            
            // Show context note if available
            const contextNote = exercise.context_note ? `<div style="font-size: 12px; color: var(--accent-color); margin-top: 5px; font-style: italic;">${exercise.context_note}</div>` : '';
            
            return `
                <li class="exercise-item ${section}-exercise expandable" onclick="toggleExerciseDetail(this, event)">
                    <div class="exercise-summary">
                        <span class="exercise-name">${exercise.name}${contextNote}</span>
                        <span class="exercise-quick-info">${quickInfo}</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="exercise-details">
                        <div class="parameter-grid">
                            <div class="param">
                                <strong>Sets</strong>
                                <div class="value">${sets}</div>
                            </div>
                            <div class="param">
                                <strong>Reps</strong>
                                <div class="value">${reps}</div>
                            </div>
                            <div class="param">
                                <strong>Rest</strong>
                                <div class="value">${exercise.rest || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>Load</strong>
                                <div class="value">${exercise.load || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>CNS Score</strong>
                                <div class="value">${exercise.cns}/10</div>
                            </div>
                            <div class="param">
                                <strong>Classification</strong>
                                <div class="value">${exercise.classification || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>Adaptation</strong>
                                <div class="value">${exercise.adaptation || 'N/A'}</div>
                            </div>
                            <div class="param">
                                <strong>Component</strong>
                                <div class="value">${exercise.component || 'N/A'}</div>
                            </div>
                            ${exercise.original_classification && exercise.original_classification !== exercise.classification ? `
                            <div class="param">
                                <strong>Original Class</strong>
                                <div class="value">${exercise.original_classification}</div>
                            </div>
                            ` : ''}
                            ${exercise.notes ? `
                            <div class="param full-width">
                                <strong>Coaching Notes</strong>
                                <div class="value">${exercise.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="exercise-actions">
                            <button class="btn btn-secondary btn-small" onclick="swapExercise('${day}', ${index}); event.stopPropagation();">Swap</button>
                            <button class="btn btn-secondary btn-small" onclick="removeExercise('${day}', ${index}); event.stopPropagation();">Remove</button>
                        </div>
                    </div>
                </li>
            `;
        }

        function updateStats(plan) {
            let totalVolume = 0;
            let highDays = 0;
            let lowDays = 0;

            Object.values(plan).forEach(day => {
                if (day.type === 'rest') return;
                
                totalVolume += day.exercises.length;
                
                if (day.type === 'high') {
                    highDays++;
                } else if (day.type === 'low') {
                    lowDays++;
                }
            });

            document.getElementById('weeklyVolume').textContent = totalVolume;
            document.getElementById('highIntensityDays').textContent = highDays;
            document.getElementById('lowIntensityDays').textContent = lowDays;
        }

        function updateProgress() {
            const progressBar = document.getElementById('weeklyProgress');
            const progress = Math.min(currentDay * 16.67, 100);
            progressBar.style.width = progress + '%';
        }

        // ==================== MODIFICATION FUNCTIONS ====================
        
        function processModification() {
            const input = document.getElementById('chatInput');
            const command = input.value.toLowerCase().trim();
            
            if (!command) return;

            addChatMessage("You", input.value);
            input.value = '';

            // Process common modifications
            if (command.includes('bodyweight')) {
                makeBodyweightOnly();
            } else if (command.includes('power') && command.includes('increase')) {
                increasePowerFocus();
            } else if (command.includes('cns') && command.includes('reduce')) {
                reduceCNSLoad();
            } else if (command.includes('volume') && command.includes('reduce')) {
                reduceVolume(20);
            } else if (command.includes('more variety') || command.includes('different exercises')) {
                regenerateWithVariety();
            } else {
                addChatMessage("Assistant", "Available modifications: 'make bodyweight only', 'increase power focus', 'reduce CNS load', 'reduce volume', 'more variety'");
            }
        }

        function makeBodyweightOnly() {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'rest') return;
                
                dayPlan.exercises = dayPlan.exercises.map(exercise => {
                    const bodyweightSub = findBodyweightSubstitution(exercise);
                    return {
                        ...exercise,
                        ...bodyweightSub,
                        context_note: 'Adapted to bodyweight while preserving training stimulus'
                    };
                });
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            addChatMessage("Assistant", "Converted to bodyweight-only while preserving ME/DE/SE/RE classifications and vertical integration sequencing.");
        }

        function findBodyweightSubstitution(exercise) {
            const classification = exercise.classification || '';
            const exerciseName = exercise.name.toLowerCase();
            
            // Max Effort substitutions with doorway isometrics
            if (classification.includes('Max Effort')) {
                if (exerciseName.includes('squat')) {
                    return { 
                        name: 'Doorway Single-Leg Squat Hold',
                        load: '100% max effort isometric',
                        notes: '90° knee angle against doorframe, maximum force production each leg'
                    };
                }
                if (exerciseName.includes('press') || exerciseName.includes('bench')) {
                    return { 
                        name: 'Doorway Chest Push (Isometric)',
                        load: '100% max effort against immovable object',
                        notes: 'Chest-height against doorframe, maximum force production'
                    };
                }
                if (exerciseName.includes('deadlift')) {
                    return { 
                        name: 'Doorway Deadlift Pull (Isometric)',
                        load: '100% max effort isometric',
                        notes: 'Hip-height pull against immovable doorframe'
                    };
                }
            }
            
            // Dynamic Effort substitutions
            if (classification.includes('Dynamic Effort')) {
                if (exerciseName.includes('clean') || exerciseName.includes('power')) {
                    return { 
                        name: 'Explosive Jump Squats',
                        load: '100% max intent',
                        notes: 'Maximum explosive effort, full reset between reps'
                    };
                }
                if (exerciseName.includes('slam') || exerciseName.includes('throw')) {
                    return { 
                        name: 'Explosive Push-ups',
                        load: '100% max intent',
                        notes: 'Hands leave ground, maximum explosive effort'
                    };
                }
            }
            
            // Default bodyweight alternatives
            return {
                name: 'Bodyweight ' + exercise.name,
                load: 'Bodyweight',
                notes: 'Bodyweight alternative maintaining training stimulus'
            };
        }

        function increasePowerFocus() {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'high') {
                    // Add more dynamic effort exercises
                    const powerExercise = {
                        name: 'Added Jump Squats',
                        classification: 'Dynamic Effort',
                        adaptation: 'Power',
                        component: 'power',
                        cns: 7,
                        sets: 4, reps: 5,
                        load: '100% max intent',
                        rest: '2min',
                        notes: 'Explosive up, soft landing',
                        context_note: 'Added for increased power focus'
                    };
                    dayPlan.exercises.unshift(powerExercise);
                    dayPlan.focus = dayPlan.focus.replace(/Strength|Mixed/, 'Power');
                }
            });
            
            displayWeeklyPlan(currentPlan);
            addChatMessage("Assistant", "Increased power focus by adding Dynamic Effort exercises with maximum explosive intent while maintaining vertical integration.");
        }

        function reduceCNSLoad() {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'high') {
                    // Remove highest CNS exercises or reduce intensity
                    dayPlan.exercises = dayPlan.exercises.filter(ex => ex.cns <= 8);
                    dayPlan.exercises.forEach(ex => {
                        if (ex.load && ex.load.includes('85%')) {
                            ex.load = ex.load.replace('85%', '80%');
                        }
                        if (ex.load && ex.load.includes('90%')) {
                            ex.load = ex.load.replace('90%', '85%');
                        }
                        // Reduce CNS score
                        ex.cns = Math.max(1, ex.cns - 1);
                        ex.context_note = 'CNS load reduced for recovery';
                    });
                }
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            addChatMessage("Assistant", "Reduced CNS load by removing highest demand exercises and reducing intensities while maintaining vertical integration structure.");
        }

        function reduceVolume(percentage) {
            if (!currentPlan) return;
            
            Object.keys(currentPlan).forEach(day => {
                const dayPlan = currentPlan[day];
                if (dayPlan.type === 'rest') return;
                
                dayPlan.exercises.forEach(exercise => {
                    if (exercise.sets && typeof exercise.sets === 'number') {
                        exercise.sets = Math.max(1, Math.floor(exercise.sets * (1 - percentage / 100)));
                        exercise.context_note = `Volume reduced by ${percentage}%`;
                    }
                });
            });
            
            displayWeeklyPlan(currentPlan);
            updateStats(currentPlan);
            addChatMessage("Assistant", `Reduced training volume by ${percentage}% while maintaining ME/DE/SE/RE structure and vertical integration sequencing.`);
        }
        
        function regenerateWithVariety() {
            if (!currentPlan) return;
            
            // Force regeneration with different exercise selection
            const button = document.querySelector('.btn[onclick="generatePlan()"]');
            button.textContent = 'Adding Variety...';
            
            // Clear cached exercises to get fresh selection
            ExerciseDBManager.cached_exercises = null;
            
            generatePlan();
            addChatMessage("Assistant", "Regenerated program with fresh exercise selection for maximum variety while preserving vertical integration principles!");
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function toggleExerciseDetail(element, event) {
            if (event) event.stopPropagation();
            element.classList.toggle('expanded');
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            
            const button = document.querySelector('.theme-toggle');
            button.innerHTML = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        function toggleCollapsible(element) {
            const collapsible = element.parentElement;
            const isActive = collapsible.classList.contains('active');
            
            // Close all other collapsibles
            document.querySelectorAll('.collapsible.active').forEach(el => {
                el.classList.remove('active');
                el.querySelector('.collapsible-header span').textContent = '+';
            });
            
            if (!isActive) {
                collapsible.classList.add('active');
                element.querySelector('span').textContent = '-';
            }
        }

        function toggleTechnical(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('show');
            }
        }

        function swapExercise(day, exerciseIndex) {
            const newExercise = prompt('Enter replacement exercise:');
            if (newExercise && currentPlan[day]) {
                currentPlan[day].exercises[exerciseIndex].name = newExercise;
                currentPlan[day].exercises[exerciseIndex].context_note = 'Custom exercise swap';
                displayWeeklyPlan(currentPlan);
                addChatMessage("Assistant", `Swapped exercise in ${day} session.`);
            }
        }

        function removeExercise(day, exerciseIndex) {
            if (currentPlan[day]) {
                const removed = currentPlan[day].exercises.splice(exerciseIndex, 1)[0];
                displayWeeklyPlan(currentPlan);
                updateStats(currentPlan);
                addChatMessage("Assistant", `Removed "${removed.name}" from ${day} session.`);
            }
        }

        function addChatMessage(sender, message) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '10px';
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ==================== INITIALIZATION ====================
        
        async function initializeApp() {
            console.log('Enhanced Three Anchor System with Dynamic Classification Starting...');
            
            // Start loading exercises in background
            ExerciseDBManager.loadExercises().then(exercises => {
                const source = exercises.some(ex => ex.source === 'exercisedb') ? 'ExerciseDB + Original' : 'Original System';
                console.log(`Exercise database ready: ${exercises.length} exercises from ${source}`);
            });
            
            // Generate initial plan automatically
            setTimeout(async () => {
                await generatePlan();
                
                const exercises = await ExerciseDBManager.loadExercises();
                const source = exercises.some(ex => ex.source === 'exercisedb') ? 'ExerciseDB + Three Anchor Intelligence' : 'Original Three Anchor System';
                
                addChatMessage("Assistant", `Welcome to the Enhanced Three Anchor Training System with Dynamic Classification! 
                    Exercises automatically adapt their classification, intensity, and volume based on your training age, current phase, and individual capacity. 
                    The same movement can be Max Effort for beginners or Repetition Effort for advanced athletes.
                    Using ${source} with ${exercises.length} exercises. Try changing your training age or phase to see dynamic adaptation in action!`);
            }, 500);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        console.log('Enhanced Three Anchor Training System with Dynamic Classification Loaded Successfully');
        console.log('Dynamic Classification: Same exercises adapt classification based on user context');
        console.log('Phase Intelligence: Exercises automatically adjust for accumulation/transmutation/realization/GPP phases');
        console.log('Training Age Adaptation: Beginner → Intermediate → Advanced contextual scaling');
        console.log('Vertical Integration: Speed → Power → Strength → Hypertrophy → Endurance sequencing');
        console.log('High-Low System: CNS-aware weekly patterns with intelligent recovery');
    </script>
</body>
</html>
